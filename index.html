<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Attendance Hub</title>
    <!-- Load Tailwind CSS CDN - FIXED version to a stable 3.4.17 -->
    <script src="https://cdn.tailwindcss.com?version=3.4.17"></script>
    <style>
      /* Custom styles for status badges */
      .status-badge {
        padding: 4px 8px;
        border-radius: 9999px;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }
      /* Style for the main content area to allow scrolling */
      .main-content {
        /* On desktop (md and up), use full height minus header/footer */
        min-height: calc(100vh - 4rem); 
        /* On mobile (sm and down), add bottom padding equal to the height of the fixed mobile nav bar (56px) */
        padding-bottom: 56px !important;
      }
      /* Utility for active sidebar link */
      .active-nav {
        background-color: #4f46e5;
        color: white;
      }
      /* Style for the calendar cell */
      .calendar-cell {
        width: 32px; /* Adjusted fixed width for smaller screens (was 40px) */
        min-width: 32px;
        height: 40px;
        text-align: center;
        padding: 0;
        cursor: pointer;
        transition: background-color 0.1s;
        font-size: 0.7rem; /* text-xs equivalent */
        font-weight: 600;
        line-height: 1; /* Adjust line height for the two lines of text */
      }
      /* Ensure date headers are also sized correctly */
      .calendar-header-cell {
          width: 32px;
          min-width: 32px;
          padding: 4px 0;
      }
      .calendar-cell:hover:not(.day-header):not(.holiday) {
        background-color: #e5e7eb; /* gray-200 */
      }
      .holiday {
        background-color: #f3f4f6; /* gray-100 */
        color: #9ca3af; /* gray-400 */
      }
      .status-P {
        background-color: #10b981;
        color: white;
      } /* Emerald-500 (Present) */
      .status-A {
        background-color: #ef4444;
        color: white;
      } /* Red-500 (Absent) */
      .status-L {
        background-color: #f59e0b;
        color: white;
      } /* Amber-500 (Late) */
      .status-PH {
        background-color: #3b82f6;
        color: white;
      } /* Blue-500 (Public Holiday) */
      .status-U {
        background-color: #9ca3af;
        color: white;
      } /* Gray-400 (Unknown/Unmarked) */
      
      /* New style for the mobile bottom nav items */
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4px 0;
        font-size: 0.6rem; /* text-[0.6rem] */
        line-height: 1;
        text-align: center;
        width: 20%;
        transition: color 0.15s;
      }
      .mobile-active-nav {
          color: #4f46e5; /* indigo-600 */
      }
      /* Hide regular sidebar on small screens */
      @media (max-width: 767px) {
          #sidebar {
              display: none;
          }
      }
      /* Style for clickable test link */
      .exam-batch-link {
          cursor: pointer;
          color: #4f46e5; /* indigo-600 */
          font-weight: 600;
          text-decoration: underline;
      }
      .exam-batch-link:hover {
          color: #3730a3; /* indigo-800 */
      }
      
      /* Style for the improved Report tabs */
      .report-tab-btn-style {
          padding: 8px 16px;
          border-radius: 9999px; /* Pill shape */
          font-weight: 600;
          transition: background-color 0.15s, color 0.15s;
          border: 1px solid transparent;
      }
      .report-tab-btn-style.active {
          background-color: #4f46e5; /* indigo-600 */
          color: white;
          border-color: #4f46e5;
      }
      .report-tab-btn-style:not(.active):hover {
          background-color: #e0e7ff; /* indigo-100 */
          color: #3730a3; /* indigo-800 */
      }

      /* Sticky Column Styles for Monthly Attendance */
      .sticky-col-roll {
          position: sticky;
          left: 0;
          z-index: 10;
          background-color: inherit;
          border-right: 1px solid #e5e7eb; /* gray-200 */
      }
      .sticky-col-name {
          position: sticky;
          left: 32px; /* Roll No width */
          z-index: 10;
          background-color: inherit;
          border-right: 1px solid #e5e7eb;
      }
      /* Ensure sticky column backgrounds are correct in the header */
      #monthly-attendance-header .sticky-col-roll {
          background-color: #4f46e5 !important; /* indigo-600 */
          left: 0;
          border-right: 1px solid #3730a3; /* indigo-800 */
      }
      #monthly-attendance-header .sticky-col-name {
          background-color: #4f46e5 !important; /* indigo-600 */
          left: 32px;
          border-right: none;
      }
      /* Ensure body sticky columns have white background */
      #monthly-calendar-body .sticky-col-roll,
      #monthly-calendar-body .sticky-col-name {
          background-color: white !important;
      }
    </style>
  </head>
  <body class="bg-gray-100 antialiased">
    <!-- Main Container -->
    <div class="flex h-screen overflow-hidden">
      <!-- Desktop Sidebar (Visible on md and up) -->
      <div
        id="sidebar"
        class="hidden md:flex w-64 bg-indigo-800 text-white flex-shrink-0 transition-all duration-300 transform md:relative z-20 shadow-xl flex-col justify-between"
      >
        <div>
          <div class="p-6">
            <h2 class="text-2xl font-bold border-b border-indigo-700 pb-3 mb-6">
              Attendance Hub
            </h2>
            <nav>
              <!-- Menu Items (Desktop Only) -->
              <a
                href="#"
                data-view="dashboard"
                class="menu-item desktop-nav flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700 active-nav"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                  ></path>
                </svg>
                Dashboard
              </a>
              <a
                href="#"
                data-view="students"
                class="menu-item desktop-nav flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m11.115-7.443-2.289-.968A3.003 3.003 0 0015 10a3 3 0 00-2.356-1.185l-2.29-.968C9.55 7.14 8.789 7 8 7V6c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v1c.789 0 1.55.14 2.228.455l2.289.968A3.003 3.003 0 0121 12a3.003 3.003 0 01-2.356 2.815l-2.289.968m-14.777-6.002C5.972 8.358 6 9.176 6 10c0 1.831-.502 3.513-1.398 4.87C4.156 15.659 3.197 16.5 2 16.5"
                  ></path>
                </svg>
                Student Management
              </a>
              <a
                href="#"
                data-view="attendance"
                class="menu-item desktop-nav flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                Monthly Attendance
              </a>
              <a
                href="#"
                data-view="reports"
                class="menu-item desktop-nav flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"
                  ></path>
                </svg>
                Reports
              </a>
              <a
                href="#"
                data-view="exams"
                class="menu-item desktop-nav flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Exam Results
              </a>
            </nav>
          </div>
        </div>
        <!-- User Info (Auth Status) - Desktop Only -->
        <div class="p-4 border-t border-indigo-700 w-full">
          <p id="user-status" class="text-sm">Status: Initializing...</p>
          <p id="user-id-display" class="text-xs break-all mt-1 opacity-70"></p>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col overflow-auto p-4 sm:p-8 main-content">
        <header class="h-16 flex items-center justify-end md:justify-start">
          <h1 id="view-title" class="text-3xl font-bold text-gray-800">
            Dashboard
          </h1>
        </header>

        <!-- Main View Container -->
        <div id="view-container" class="flex-1 mt-4">
          <!-- Content will be injected here -->
        </div>

        <footer class="mt-8 pt-4 text-center text-gray-500 text-sm md:border-t hidden md:block">
          Designed By Rakesh Kadel
        </footer>
      </div>

      <!-- Mobile Bottom Navigation Bar (Visible only on sm and below) -->
      <div id="mobile-nav" class="fixed bottom-0 left-0 right-0 h-14 bg-white border-t border-gray-200 shadow-xl flex justify-around items-center z-30 md:hidden">
            <a href="#" data-view="dashboard" class="menu-item mobile-nav-item text-gray-500 mobile-active-nav">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Dashboard
            </a>
            <a href="#" data-view="students" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m11.115-7.443-2.289-.968A3.003 3.003 0 0015 10a3 3 0 00-2.356-1.185l-2.29-.968C9.55 7.14 8.789 7 8 7V6c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v1c.789 0 1.55.14 2.228.455l2.289.968A3.003 3.003 0 0121 12a3.003 3.003 0 01-2.356 2.815l-2.289.968m-14.777-6.002C5.972 8.358 6 9.176 6 10c0 1.831-.502 3.513-1.398 4.87C4.156 15.659 3.197 16.5 2 16.5"></path></svg>
                Students
            </a>
            <a href="#" data-view="attendance" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Attendance
            </a>
            <a href="#" data-view="reports" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path></svg>
                Reports
            </a>
            <a href="#" data-view="exams" class="menu-item mobile-nav-item text-gray-500">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Exams
            </a>
            <div class="mobile-nav-item" id="mobile-status-container">
                <p class="text-[0.6rem] text-gray-400">Status:</p>
                <p id="mobile-user-status" class="text-[0.6rem] font-semibold text-gray-500">...</p>
            </div>
      </div>

    </div>
    
    <!-- MODAL 1: Exam Details Modal Container (Hidden by default) -->
    <div id="exam-details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Exam Results Details</h3>
                <button onclick="closeModal('exam-details-modal')" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Detailed results table will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- MODAL 2: Student Edit Modal Container (Hidden by default) -->
    <div id="edit-student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <form id="edit-student-form">
                <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                    <h3 class="text-xl font-bold text-indigo-700">Edit Student Details</h3>
                    <button type="button" onclick="closeModal('edit-student-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-student-id">
                    <div>
                        <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                        <input type="text" id="edit-student-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-student-rollno" class="block text-sm font-medium text-gray-700">Roll No. (ID)</label>
                        <input type="number" id="edit-student-rollno" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-student-grade" class="block text-sm font-medium text-gray-700">Grade Level</label>
                        <input type="text" id="edit-student-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <p id="edit-student-message" class="text-sm font-semibold h-5"></p>
                </div>
                <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('edit-student-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase Imports -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        collection,
        onSnapshot,
        addDoc,
        deleteDoc,
        query,
        orderBy,
        setDoc,
        updateDoc, // <-- ADDED
        where,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- FIREBASE CONFIGURATION (Hardcoded for Netlify Deployment) ---
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyAjfgjWwe3yBGsC2SjQGbF5a4rWf8rXyZM",
        authDomain: "student-attendance-a9e41.firebaseapp.com",
        projectId: "student-attendance-a9e41",
        storageBucket: "student-attendance-a9e41.firebasestorage.app",
        messagingSenderId: "22011088154",
        appId: "1:22011088154:web:13a1655b254138448830a3",
      };
      // The projectId is used as the unique identifier for the Firestore path
      const DEPLOYMENT_APP_ID = FIREBASE_CONFIG.projectId; 
      const INITIAL_AUTH_TOKEN = null; // Not needed for Netlify

      let db, auth; // Declare Firebase instances globally
      let students = []; // Holds all student records
      let allAttendanceRecords = []; // Holds all attendance records for reporting
      let allExamRecords = []; // **NEW: Holds all exam records**
      let currentView = "dashboard";
      let userId = null;
      let monthlyViewDate = new Date(); // Tracks the currently viewed month/year
      let weeklyViewOffset = 0; // Tracks the current week offset (0 = current week)

      // --- GRADE MANAGEMENT STATE ---
      let allGrades = []; // Array of unique grades (e.g., ['9', '10A', '7B'])
      let attendanceFilterGrade = '7B'; // **DEFAULT GRADE for Attendance View**
      let selectedExamGrade = ''; // Grade currently selected in the Exam Results INPUT form


      // DOM Elements
      const viewContainer = document.getElementById("view-container");
      const viewTitle = document.getElementById("view-title");
      const userStatusEl = document.getElementById("user-status"); // Desktop status
      const userIdDisplayEl = document.getElementById("user-id-display"); // Desktop User ID
      const mobileUserStatusEl = document.getElementById("mobile-user-status"); // Mobile status
      const examDetailsModal = document.getElementById('exam-details-modal');
      const editStudentModal = document.getElementById('edit-student-modal'); // **NEW**


      // --- FIREBASE INITIALIZATION ---

      function initializeFirebase() {
        if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.projectId) {
          console.error("Firebase configuration is missing.");
          userStatusEl.textContent = "Error: Config Missing.";
          mobileUserStatusEl.textContent = "Error!";
          return;
        }

        console.log("[DIAGNOSTIC] Attempting Firebase Initialization...");
        // Initialize Firebase
        const app = initializeApp(FIREBASE_CONFIG);
        db = getFirestore(app);
        auth = getAuth(app);

        setLogLevel("Debug");

        // Set up Authentication Listener
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userStatusEl.textContent = "Status: Connected";
            mobileUserStatusEl.textContent = "Connected";
            userIdDisplayEl.textContent = `User ID: ${userId}`;

            // Once authenticated, start listening for data
            setupDataListeners();
          } else {
            handleAuth();
          }
        });

        renderView("dashboard");
      }

      // --- FIREBASE PATHS & FUNCTIONS ---

      const getStudentCollectionRef = () =>
        collection(db, "artifacts", DEPLOYMENT_APP_ID, "public", "data", "students");
      const getAttendanceCollectionRef = () =>
        collection(
          db,
          "artifacts",
          DEPLOYMENT_APP_ID,
          "public",
          "data",
          "attendance_records"
        );
      const getExamCollectionRef = () =>
        collection(
          db,
          "artifacts",
          DEPLOYMENT_APP_ID,
          "public",
          "data",
          "exam_results"
        );


      async function handleAuth() {
        try {
          if (INITIAL_AUTH_TOKEN) {
            await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
          } else {
            // Sign in anonymously for public data access
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Firebase Auth Error:", error);
          userStatusEl.textContent = "Status: Auth Error!";
          mobileUserStatusEl.textContent = "Auth Error!";
        }
      }

      async function addStudent(name, rollNo, grade) {
        if (!userId) {
          console.error("User not authenticated.");
          return;
        }
        try {
          // Normalize grade before saving to ensure consistent filtering later
          const normalizedGrade = grade.trim().toUpperCase(); 
          
          await addDoc(getStudentCollectionRef(), {
            name: name,
            rollNo: rollNo,
            grade: normalizedGrade, // <-- SAVED: Normalized Grade Level
            createdAt: new Date(),
          });
          showMessage(`Student ${name} (Grade ${normalizedGrade}) added successfully!`, "green");
        } catch (e) {
          console.error("Error adding student: ", e);
          showMessage("Error adding student.", "red");
        }
      }
      
      // **NEW: Update Student Function**
      window.updateStudentDetails = async function(id, name, rollNo, grade) {
        if (!userId) {
          showMessage("User not authenticated.", "red");
          return;
        }
        try {
            // Normalize grade before saving
            const normalizedGrade = grade.trim().toUpperCase();
            
            const studentRef = doc(getStudentCollectionRef(), id);
            await updateDoc(studentRef, {
                name: name,
                rollNo: rollNo,
                grade: normalizedGrade,
            });
            showMessage(`Student ${name} details updated successfully!`, "green");
            closeModal('edit-student-modal');
        } catch (e) {
            console.error("Error updating student: ", e);
            showMessage("Error updating student details.", "red");
        }
      }

      async function deleteStudent(id) {
        if (!userId) {
          console.error("User not authenticated.");
          return;
        }
        try {
          await deleteDoc(doc(getStudentCollectionRef(), id));
          showMessage("Student deleted successfully!", "green");
        } catch (e) {
          console.error("Error deleting student: ", e);
          showMessage("Error deleting student.", "red");
        }
      }

      // Function to set or update a single attendance record
      async function setAttendanceRecord(studentId, date, status) {
        if (!userId) return;
        const docId = `${studentId}_${date}`;
        const attendanceRef = doc(getAttendanceCollectionRef(), docId);

        try {
          await setDoc(
            attendanceRef,
            {
              studentId: studentId,
              date: date,
              status: status,
              timestamp: new Date(),
            },
            { merge: true }
          );
          // UI update happens automatically via the global onSnapshot listener for allAttendanceRecords
        } catch (e) {
          console.error("Error setting attendance record: ", e);
          showMessage("Error saving attendance mark.", "red");
        }
      }

      async function markMonthPresent(year, month) {
        // Filter students based on current attendance filter grade
        const studentsToMark = getStudentsByGrade(attendanceFilterGrade);

        if (!userId || studentsToMark.length === 0) {
          showMessage(
            "Error: User not authenticated or no students available in the current grade.",
            "red"
          );
          return;
        }

        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0);
        const daysInMonth = endDate.getDate();
        const monthName = startDate.toLocaleString("default", {
          month: "long",
        });

        let batch = writeBatch(db);
        let totalRecords = 0;

        for (let day = 1; day <= daysInMonth; day++) {
          const currentDate = new Date(year, month - 1, day);
          const dateStr = currentDate.toISOString().slice(0, 10);

          const dayOfWeek = currentDate.getDay(); // 0=Sun, 6=Sat

          // Only skip Saturday (6) - School is Sun-Fri
          if (dayOfWeek === 6) {
            continue;
          }

          studentsToMark.forEach((student) => {
            const docId = `${student.id}_${dateStr}`;
            const attendanceRef = doc(getAttendanceCollectionRef(), docId);

            batch.set(
              attendanceRef,
              {
                studentId: student.id,
                date: dateStr,
                status: "Present",
                timestamp: new Date(),
              },
              { merge: true }
            );
            totalRecords++;

            if (totalRecords % 490 === 0) {
              console.log(`Committing intermediate batch...`);
              batch.commit();
              batch = writeBatch(db);
            }
          });
        }

        try {
          await batch.commit();
          showMessage(
            `Successfully marked ${studentsToMark.length} students in Grade ${attendanceFilterGrade} Present for all school days (Sun-Fri) in ${monthName} ${year}. Total records processed: ${totalRecords}.`,
            "green"
          );
        } catch (e) {
          console.error("Batch write error during monthly mark: ", e);
          showMessage("Error marking monthly attendance. Check console for details.", "red");
        }
      }

      async function saveExamResults(subject, type, maxMarks, date, scores) {
        if (!userId) {
          showMessage("Error: User not authenticated.", "red");
          return;
        }
        if (students.length === 0) {
          showMessage("Error: No students to score.", "red");
          return;
        }

        // Generate a unique ID for this exam batch
        const examBatchId = `${subject}_${type}_${date}`.replace(/\s/g, '_');
        
        let batch = writeBatch(db);
        let validScores = 0;

        students.forEach(student => {
            const score = scores[student.id];
            
            // Find the student's full data object to get the grade
            const studentData = students.find(s => s.id === student.id);
            // Grade is already normalized in the student object
            const studentGrade = studentData?.grade || 'UNKNOWN'; 

            // Only save if a score was entered
            if (score !== undefined && score !== null && score !== "") {
                const docId = `${examBatchId}_${student.id}`;
                const examRef = doc(getExamCollectionRef(), docId);
                
                batch.set(examRef, {
                    examBatchId: examBatchId,
                    studentId: student.id,
                    studentName: student.name,
                    studentGrade: studentGrade, // <-- SAVED: Normalized Grade
                    subject: subject,
                    type: type,
                    date: date,
                    maxMarks: parseInt(maxMarks),
                    score: parseFloat(score),
                    timestamp: new Date(),
                });
                validScores++;
            }
        });

        if (validScores === 0) {
            showMessage("Please enter at least one student's score to save the results.", "red");
            return;
        }

        try {
            await batch.commit();
            showMessage(`Successfully saved results for ${validScores} students for ${subject} (${type}).`, "green");
            // Optionally clear the form or reset the view
            renderExamResults(); 
        } catch (e) {
            console.error("Batch write error during exam results save: ", e);
            showMessage("Error saving exam results. Check console.", "red");
        }
      }
      
      // --- FIX: Updated Function to delete an entire Exam Batch ---
      window.deleteExamBatch = async function(batchId, subject, type) {
          console.log(`[DELETE] Attempting to delete batch ID: ${batchId}`);
          
          if (!userId) {
              showMessage("User not authenticated. Cannot delete.", "red");
              console.error("[DELETE] Error: User not authenticated.");
              return;
          }
          
          if (confirm(`Are you sure you want to permanently delete ALL results for the exam: ${subject} - ${type}? This action cannot be undone.`)) {
              
              const recordsToDelete = allExamRecords.filter(r => r.examBatchId === batchId);
              
              if (recordsToDelete.length === 0) {
                  showMessage("Error: No records found for this batch.", "red");
                  console.warn(`[DELETE] Warning: No records found in cache for batch ID: ${batchId}`);
                  return;
              }
              
              console.log(`[DELETE] Found ${recordsToDelete.length} records. Starting batch write deletion.`);

              let batch = writeBatch(db);
              recordsToDelete.forEach(record => {
                  const docRef = doc(getExamCollectionRef(), record.id);
                  batch.delete(docRef);
                  console.log(`[DELETE] Queued document for deletion: ${record.id}`);
              });
              
              try {
                  await batch.commit();
                  showMessage(`Successfully deleted ${recordsToDelete.length} records for ${subject} - ${type}.`, "green");
                  console.log(`[DELETE] Batch commit successful.`);
                  // The onSnapshot listener will handle the UI update automatically
              } catch (e) {
                  console.error("[DELETE] Error deleting exam batch:", e);
                  showMessage("Error deleting exam records. Check console.", "red");
              }
          } else {
               console.log("[DELETE] Deletion cancelled by user.");
          }
      }

      // --- DATA LISTENERS ---

      function setupDataListeners() {
        if (!userId) return;

        // 1. Student Listener
        const qStudents = getStudentCollectionRef();
        onSnapshot(
          qStudents,
          (snapshot) => {
            const newStudents = [];
            snapshot.forEach((doc) => {
              newStudents.push({ id: doc.id, ...doc.data() });
            });
            students = newStudents.sort((a, b) => a.rollNo - b.rollNo); // Keep sorted

            // Calculate unique grades
            const gradesSet = new Set(newStudents.map(s => s.grade).filter(Boolean).map(g => g.trim().toUpperCase()));
            // Keep allGrades list capitalized and sorted for UI selectors
            allGrades = Array.from(gradesSet).sort(); 
            
            // If the default filter grade is no longer valid, reset it.
            if (!allGrades.includes(attendanceFilterGrade)) {
                attendanceFilterGrade = allGrades[0] || '';
            }


            // Re-render the current view to reflect new student list/stats
            renderView(currentView);
          },
          (error) => {
            console.error("Error fetching students:", error);
            showMessage("Could not load student list.", "red");
          }
        );

        // 2. All Attendance Listener (for comprehensive reports/dashboard)
        const qAttendance = getAttendanceCollectionRef();

        onSnapshot(
          qAttendance,
          (snapshot) => {
            allAttendanceRecords = [];
            snapshot.forEach((doc) => {
              allAttendanceRecords.push({ id: doc.id, ...doc.data() });
            });

            // Re-render reports/dashboard immediately when attendance changes
            if (
              currentView === "dashboard" ||
              currentView === "reports" ||
              currentView === "attendance"
            ) {
              renderView(currentView);
            }
          },
          (error) => {
            console.error("Error fetching all attendance records:", error);
          }
        );
        
        // 3. All Exam Results Listener (NEW)
        const qExams = getExamCollectionRef();
        onSnapshot(
          qExams,
          (snapshot) => {
            allExamRecords = [];
            snapshot.forEach((doc) => {
              allExamRecords.push({ id: doc.id, ...doc.data() });
            });

            if (currentView === "reports" || currentView === "students" || currentView === "exams") { 
              renderView(currentView); 
            }
          },
          (error) => {
            console.error("Error fetching exam records:", error);
          }
        );
      }
      
      // --- HELPER FUNCTIONS ---

      // **FIXED**: Normalizes both the filter grade and the student's grade for reliable matching.
      function getStudentsByGrade(grade) {
          const normalizedFilter = grade ? grade.trim().toUpperCase() : null;
          
          if (!normalizedFilter || normalizedFilter === 'ALL' || normalizedFilter === 'UNASSIGNED') return students;
          
          return students.filter(s => {
              // Ensure student.grade exists and normalize it for comparison
              const normalizedStudentGrade = s.grade ? String(s.grade).trim().toUpperCase() : 'UNKNOWN';
              return normalizedStudentGrade === normalizedFilter;
          });
      }

      // --- DATA CALCULATION ---

      function calculateAttendanceStats() {
        // ... (function body remains the same, it operates on 'students' array)
        const stats = {
          totalStudents: students.length,
          totalAttendanceDays: 0,
          totalPresent: 0,
          totalAbsent: 0,
          totalLate: 0,
          totalPublicHolidays: 0,
          totalPresentUntilLastMonth: 0,
          studentStats: {}, // {studentId: {present, absent, late, publicHoliday, percentage, presentThisMonth, presentTillLastMonth}}
        };

        const daySet = new Set();
        const today = new Date();
        const currentMonthPrefix = today.toISOString().slice(0, 7);

        students.forEach((s) => {
          stats.studentStats[s.id] = {
            present: 0,
            absent: 0,
            late: 0,
            publicHoliday: 0,
            totalMarkedDays: 0,
            percentage: 0,
            presentThisMonth: 0, 
            presentTillLastMonth: 0,
          };
        });

        allAttendanceRecords.forEach((record) => {
          daySet.add(record.date);
          const studentId = record.studentId;
          const status = record.status;
          const recordDatePrefix = record.date.slice(0, 7);

          if (stats.studentStats[studentId]) {
            const studentStat = stats.studentStats[studentId];
            studentStat.totalMarkedDays++;

            const isPresentOrLate = status === "Present" || status === "Late";
            const isLastMonthOrEarlier = recordDatePrefix !== currentMonthPrefix;

            if (status === "Present") {
              stats.totalPresent++;
              studentStat.present++;
            } else if (status === "Absent") {
              stats.totalAbsent++;
              studentStat.absent++;
            } else if (status === "Late") {
              stats.totalLate++;
              studentStat.late++;
            } else if (status === "PH") {
              stats.totalPublicHolidays++;
              studentStat.publicHoliday++;
            }

            // Calculate present counts for reporting columns
            if (isPresentOrLate) {
                if (isLastMonthOrEarlier) {
                    studentStat.presentTillLastMonth++;
                    stats.totalPresentUntilLastMonth++;
                } else {
                    studentStat.presentThisMonth++;
                }
            }
          }
        });

        stats.totalAttendanceDays = daySet.size;

        // Calculate student percentages and global percentage
        let totalExpectedMarks = 0; // P + A + L (excluding PH)
        let totalActualPresent = 0; // P + L

        students.forEach((s) => {
          const studentStat = stats.studentStats[s.id];
          if (studentStat) {
            const expectedMarks =
              studentStat.present + studentStat.absent + studentStat.late;
            totalExpectedMarks += expectedMarks;
            totalActualPresent += studentStat.present + studentStat.late;
            
            // Total Present is the sum of all P + L
            studentStat.totalPresent = studentStat.present + studentStat.late;

            if (expectedMarks > 0) {
              // Percentage is (Present + Late) / (Present + Absent + Late)
              studentStat.percentage =
                ((studentStat.present + studentStat.late) / expectedMarks) *
                100;
            }
          }
        });

        stats.globalPercentage =
          totalExpectedMarks > 0
            ? (totalActualPresent / totalExpectedMarks) * 100
            : 0;

        // Determine top 10 students
        const sortedStudents = students
          .map((s) => ({
            name: s.name,
            percentage: stats.studentStats[s.id]?.percentage || 0,
          }))
          .sort((a, b) => b.percentage - a.percentage);

        stats.top10Students = sortedStudents.slice(0, 10);

        return stats;
      }
      
      function calculateStudentExamAverages() {
        const studentAverages = {}; // {studentId: {totalScore, totalMaxMarks, percentage, subjects: {subjectName: averagePercent}}}

        students.forEach(s => {
            studentAverages[s.id] = {
                totalScore: 0,
                totalMaxMarks: 0,
                percentage: 0,
                subjects: {},
                examCount: 0
            };
        });

        const subjectScores = {}; // {studentId: {subject: {scoreSum, maxSum}}}

        allExamRecords.forEach(record => {
            const studentId = record.studentId;
            const subject = record.subject;
            const score = record.score;
            const maxMarks = record.maxMarks;

            if (studentAverages[studentId]) {
                // Global Totals
                studentAverages[studentId].totalScore += score;
                studentAverages[studentId].totalMaxMarks += maxMarks;
                studentAverages[studentId].examCount++;

                // Subject Totals
                if (!subjectScores[studentId]) {
                    subjectScores[studentId] = {};
                }
                if (!subjectScores[studentId][subject]) {
                    subjectScores[studentId][subject] = { scoreSum: 0, maxSum: 0 };
                }
                subjectScores[studentId][subject].scoreSum += score;
                subjectScores[studentId][subject].maxSum += maxMarks;
            }
        });

        // Calculate final percentages
        Object.keys(studentAverages).forEach(studentId => {
            const avg = studentAverages[studentId];
            if (avg.totalMaxMarks > 0) {
                avg.percentage = (avg.totalScore / avg.totalMaxMarks) * 100;
            }

            // Calculate subject averages
            if (subjectScores[studentId]) {
                Object.keys(subjectScores[studentId]).forEach(subject => {
                    const sub = subjectScores[studentId][subject];
                    if (sub.maxSum > 0) {
                        avg.subjects[subject] = (sub.scoreSum / sub.maxSum) * 100;
                    }
                });
            }
        });

        return studentAverages;
      }

      // --- UI & STATE MANAGEMENT ---

      function getStatusClasses(status) {
        return `status-${status.charAt(0)}`;
      }

      function showMessage(text, color) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = `text-sm font-semibold h-5 mt-1 ${
          color === "green" ? "text-green-600" : "text-red-600"
        }`;
        setTimeout(() => (messageEl.textContent = ""), 4000);
      }
      
      // Helper function to show messages in the Edit Student Modal
      function showEditMessage(text, color) {
        const messageEl = document.getElementById("edit-student-message");
        messageEl.textContent = text;
        messageEl.className = `text-sm font-semibold h-5 mt-1 ${
          color === "green" ? "text-green-600" : "text-red-600"
        }`;
        setTimeout(() => (messageEl.textContent = ""), 4000);
      }

      function setActiveNav(viewName) {
        // 1. Desktop Nav
        document.querySelectorAll(".desktop-nav").forEach((item) => {
          item.classList.remove("active-nav");
          if (item.dataset.view === viewName) {
            item.classList.add("active-nav");
          }
        });

        // 2. Mobile Nav
        document.querySelectorAll(".mobile-nav-item").forEach((item) => {
            item.classList.remove("mobile-active-nav", "text-indigo-600");
            item.classList.add("text-gray-500");
            if (item.dataset.view === viewName) {
                item.classList.add("mobile-active-nav", "text-indigo-600");
                item.classList.remove("text-gray-500");
            }
        });
      }

      function renderView(viewName) {
        currentView = viewName;
        setActiveNav(viewName);

        // Update Title
        const menuItem = document.querySelector(`.menu-item[data-view="${viewName}"]`);
        if (menuItem) {
            // Use desktop item text for the title since it's more descriptive
            viewTitle.textContent = menuItem.textContent.trim();
        }

        viewContainer.innerHTML = "";

        // The sidebar is hidden on mobile now, so we don't need the toggle logic here
        
        switch (viewName) {
          case "dashboard":
            renderDashboard();
            break;
          case "students":
            renderStudentManagement();
            break;
          case "attendance":
            renderMonthlyAttendance(); // Renamed function
            break;
          case "reports":
            renderReports();
            break;
          case "exams":
            renderExamResults();
            break;
        }
      }

      // --- VIEW RENDERING FUNCTIONS ---

      function renderDashboard() {
        const stats = calculateAttendanceStats();

        const topStudentsList =
          stats.top10Students
            .map(
              (s) =>
                `<li class="text-gray-700">${s.name}: ${s.percentage.toFixed(
                  1
                )}%</li>`
            )
            .join("") || "<li>No data yet.</li>";

        const html = `
                <div class="space-y-6">
                    <p class="text-xl font-medium text-gray-600">Welcome to the Dashboard! Here's a quick overview of your class data.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                            <p class="text-sm font-medium text-gray-500">Total Students</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${
                              stats.totalStudents
                            }</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <p class="text-sm font-medium text-gray-500">Total Present (Cumulative)</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${
                              stats.totalPresent + stats.totalLate
                            }</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                            <p class="text-sm font-medium text-gray-500">Overall Attendance %</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${stats.globalPercentage.toFixed(
                              1
                            )}%</p>
                        </div>
                    </div>
                    
                    <div id="dashboard-charts" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Top 10 Students by Attendance</h3>
                        <ol class="list-decimal list-inside space-y-1">
                            ${topStudentsList}
                        </ol>
                        <p class="text-sm text-gray-500 italic mt-4">Calculated based on marked attendance days (excluding PH).</p>
                    </div>
                </div>
            `;
        viewContainer.innerHTML = html;
      }

      function renderStudentManagement() {
        // Use a dataset attribute on the view container to maintain tab state across renders
        let currentStudentTab = viewContainer.dataset.studentTab || 'management';

        const tabHtml = `
            <div class="space-y-6">
                <p id="message" class="text-sm font-semibold h-5"></p>
                
                <!-- Tab Navigation for Student Management -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <button 
                            data-tab="management" 
                            class="student-tab-btn report-tab-btn-style ${currentStudentTab === 'management' ? 'active' : 'bg-gray-200 text-gray-700'}"
                        >
                            Add / Remove Students
                        </button>
                        <button 
                            data-tab="performance" 
                            class="student-tab-btn report-tab-btn-style ${currentStudentTab === 'performance' ? 'active' : 'bg-gray-200 text-gray-700'}"
                        >
                            Student Performance
                        </button>
                    </div>
                    <div class="mt-4 h-1"></div>
                </div>
                
                <div id="student-tab-content">
                    <!-- Tab content loaded here -->
                </div>
            </div>
        `;

        viewContainer.innerHTML = tabHtml;
        
        // Set up tab switching logic
        document.querySelectorAll('.student-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const newTab = e.target.dataset.tab;
                viewContainer.dataset.studentTab = newTab; // Save new state
                renderView('students'); // Re-render the view to apply changes
            });
        });
        
        // Render the correct tab content
        const contentEl = document.getElementById('student-tab-content');
        if (currentStudentTab === 'management') {
            contentEl.innerHTML = renderAddDeleteStudentTab();
            // Reattach event listeners after DOM update
            setupStudentManagementListeners();
            updateStudentListMgmt();
        } else {
            contentEl.innerHTML = renderStudentPerformanceTab();
        }
      }

      function renderAddDeleteStudentTab() {
        return `
            <div class="max-w-4xl mx-auto space-y-6">
                
                <!-- Add Student Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Add New Student (${students.length})</h3>
                    <form id="add-student-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                                <input type="text" id="student-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="student-rollno" class="block text-sm font-medium text-gray-700">Roll No. (ID)</label>
                                <input type="number" id="student-rollno" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="student-grade" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                <input type="text" id="student-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 9, 10A, 7B">
                            </div>
                        </div>
                        <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">
                            Add Student
                        </button>
                    </form>
                </div>

                <!-- Student List Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Current Students List</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Roll No.</th>
                                    <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Name</th>
                                    <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Grade</th>
                                    <th class="py-3 px-4 sm:px-6 font-bold text-gray-600 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-mgmt" class="divide-y divide-gray-200">
                                <!-- Student rows here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
      }
      
      function setupStudentManagementListeners() {
        document
          .getElementById("add-student-form")
          ?.addEventListener("submit", (e) => {
            e.preventDefault();
            const name = document.getElementById("student-name").value.trim();
            const rollNo = parseInt(
              document.getElementById("student-rollno").value
            );
            const grade = document.getElementById("student-grade").value.trim();
            if (name && rollNo && grade) {
              addStudent(name, rollNo, grade);
              e.target.reset(); // Clear form
              document.getElementById("student-name").focus(); // Focus back to name field
            }
          });
          
        // **NEW: Edit Student Form Listener**
        document.getElementById('edit-student-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById("edit-student-id").value;
            const name = document.getElementById("edit-student-name").value.trim();
            const rollNo = parseInt(document.getElementById("edit-student-rollno").value);
            const grade = document.getElementById("edit-student-grade").value.trim();
            
            if (name && rollNo && grade && id) {
                updateStudentDetails(id, name, rollNo, grade);
            } else {
                showEditMessage("All fields must be filled.", "red");
            }
        });


        document
          .getElementById("student-list-mgmt")
          ?.addEventListener("click", (e) => {
            if (e.target.closest(".delete-btn")) {
              const studentId = e.target.closest(".delete-btn").dataset.id;
              if (confirm("Are you sure you want to delete this student permanently?")) {
                  deleteStudent(studentId);
              }
            }
            // **NEW: Handle Edit Button Click**
            if (e.target.closest(".edit-btn")) {
                const studentId = e.target.closest(".edit-btn").dataset.id;
                const studentData = students.find(s => s.id === studentId);
                if (studentData) {
                    openEditStudentModal(studentData);
                }
            }
          });
      }
      
      // **NEW: Open Edit Student Modal Function**
      window.openEditStudentModal = function(student) {
          document.getElementById("edit-student-id").value = student.id;
          document.getElementById("edit-student-name").value = student.name;
          document.getElementById("edit-student-rollno").value = student.rollNo;
          document.getElementById("edit-student-grade").value = student.grade;
          showEditMessage("", "green"); // Clear previous messages
          editStudentModal.classList.remove('hidden');
      }

      function renderStudentPerformanceTab() {
          const studentAverages = calculateStudentExamAverages();
          
          if (students.length === 0) {
              return `<div class="p-8 bg-white rounded-xl shadow-lg text-center text-gray-600">No students available.</div>`;
          }
          
          if (Object.keys(studentAverages).every(id => studentAverages[id].examCount === 0)) {
              return `<div class="p-8 bg-white rounded-xl shadow-lg text-center text-gray-600">No exam results recorded yet. Please add scores in the Exam Results view.</div>`;
          }
          
          // Determine all subjects taken to create dynamic columns
          const allSubjects = new Set();
          Object.values(studentAverages).forEach(avg => {
              Object.keys(avg.subjects).forEach(subject => allSubjects.add(subject));
          });
          const subjects = Array.from(allSubjects).sort();
          
          // Generate table rows
          const performanceRows = students.map(s => {
              const avg = studentAverages[s.id];
              const percentage = avg?.percentage || 0;
              
              let subjectCells = subjects.map(subject => {
                  const subPercent = avg?.subjects[subject];
                  if (subPercent !== undefined) {
                      const colorClass = subPercent >= 70 ? 'text-green-600 font-semibold' : 'text-red-600';
                      return `<td class="py-3 px-4 text-center ${colorClass}">${subPercent.toFixed(1)}%</td>`;
                  }
                  return `<td class="py-3 px-4 text-center text-gray-400">--</td>`;
              }).join('');

              return `
                  <tr class="hover:bg-gray-50">
                      <td class="py-3 px-4 font-medium text-gray-900">${s.rollNo}</td>
                      <td class="py-3 px-4 text-gray-700">${s.name}</td>
                      <td class="py-3 px-4 text-gray-700">${s.grade || 'N/A'}</td>
                      ${subjectCells}
                      <td class="py-3 px-4 text-center font-extrabold ${percentage >= 70 ? 'text-indigo-600' : 'text-red-600'}">${percentage.toFixed(1)}%</td>
                      <td class="py-3 px-4 text-center text-gray-500">${avg?.examCount || 0}</td>
                  </tr>
              `;
          }).join('');

          const subjectHeaders = subjects.map(s => 
            `<th class="py-3 px-4 font-bold text-gray-600 text-center">${s} Avg %</th>`
          ).join('');

          return `
              <div class="bg-white p-6 rounded-xl shadow-lg">
                  <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Exam Performance Breakdown</h3>
                  <div class="overflow-x-auto">
                      <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                          <thead class="bg-gray-50">
                              <tr>
                                  <th class="py-3 px-4 font-bold text-gray-600">Roll No.</th>
                                  <th class="py-3 px-4 font-bold text-gray-600">Name</th>
                                  <th class="py-3 px-4 font-bold text-gray-600">Grade</th>
                                  ${subjectHeaders}
                                  <th class="py-3 px-4 font-bold text-gray-600 text-center sticky right-0 bg-gray-50 border-l border-gray-200">Overall Avg %</th>
                                  <th class="py-3 px-4 font-bold text-gray-600 text-center">Exams Taken</th>
                              </tr>
                          </thead>
                          <tbody class="divide-y divide-gray-200">
                              ${performanceRows}
                          </tbody>
                      </table>
                  </div>
                  <p class="text-xs text-gray-500 italic mt-4">Overall Avg % is calculated across all recorded exams for the student.</p>
              </div>
          `;
      }

      function updateStudentListMgmt() {
        const listBody = document.getElementById("student-list-mgmt");
        if (!listBody) return;

        listBody.innerHTML = "";
        
        // Group students by Grade
        const studentsByGrade = students.reduce((acc, student) => {
            // Use the normalized grade for grouping
            const grade = student.grade ? student.grade.trim().toUpperCase() : 'UNASSIGNED';
            if (!acc[grade]) {
                acc[grade] = [];
            }
            acc[grade].push(student);
            return acc;
        }, {});

        // Sort grades (e.g., '7B', '9', '10A')
        const gradesToDisplay = Object.keys(studentsByGrade).sort();

        gradesToDisplay.forEach(grade => {
            // Add Grade Header
            const headerRow = document.createElement("tr");
            headerRow.classList.add("bg-indigo-100", "font-bold");
            headerRow.innerHTML = `<td colspan="4" class="py-2 px-4 text-indigo-800">${grade} (${studentsByGrade[grade].length} Students)</td>`;
            listBody.appendChild(headerRow);

            // Add student rows for this grade
            studentsByGrade[grade].forEach((student) => {
                const row = document.createElement("tr");
                row.classList.add("hover:bg-gray-50");
                row.innerHTML = `
                            <td class="py-3 px-4 sm:px-6 text-gray-900">${student.rollNo}</td>
                            <td class="py-3 px-4 sm:px-6 text-gray-700">${student.name}</td>
                            <td class="py-3 px-4 sm:px-6 text-gray-700">${student.grade || 'N/A'}</td>
                            <td class="py-3 px-4 sm:px-6 text-center space-x-2">
                                <button class="edit-btn px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 text-xs" data-id="${student.id}">Edit</button>
                                <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150 text-xs" data-id="${student.id}">Delete</button>
                            </td>
                        `;
                listBody.appendChild(row);
            });
        });
      }

      function renderMonthlyAttendance() {
        const currentYear = monthlyViewDate.getFullYear();
        const currentMonth = monthlyViewDate.getMonth() + 1; // 1-indexed
        
        // --- NEW: Filter Students based on selected grade ---
        const studentsForAttendance = getStudentsByGrade(attendanceFilterGrade);
        // --- END NEW ---

        // Find the first day of the currently selected month
        const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
        
        // Calculate the starting day for the current view (Sunday of the week defined by weeklyViewOffset)
        const dayOfWeek = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
        const daysToSubtract = dayOfWeek === 0 ? 0 : dayOfWeek; // Assuming Sunday is the start of the week (0)
        
        // Calculate the start date of the visible week range
        const viewStartDate = new Date(currentYear, currentMonth - 1, firstDayOfMonth.getDate() - daysToSubtract + (weeklyViewOffset * 7));
        
        // Calculate the end date of the visible week range (7 days later)
        const viewEndDate = new Date(viewStartDate);
        viewEndDate.setDate(viewEndDate.getDate() + 6);

        // Determine if the navigation buttons should be disabled
        const prevButtonDisabled = viewStartDate.getMonth() + 1 !== currentMonth && weeklyViewOffset <= 0;
        const nextButtonDisabled = viewEndDate.getMonth() + 1 !== currentMonth && weeklyViewOffset >= 0;

        const monthOptions = [
          { val: 1, name: "January" },
          { val: 2, name: "February" },
          { val: 3, name: "March" },
          { val: 4, name: "April" },
          { val: 5, name: "May" },
          { val: 6, name: "June" },
          { val: 7, name: "July" },
          { val: 8, name: "August" },
          { val: 9, name: "September" },
          { val: 10, name: "October" },
          { val: 11, name: "November" },
          { val: 12, name: "December" },
        ]
          .map(
            (m) =>
              `<option value="${m.val}" ${
                m.val === currentMonth ? "selected" : ""
              }>${m.name}</option>`
          )
          .join("");

        const yearOptions = [currentYear - 1, currentYear, currentYear + 1]
          .map(
            (y) =>
              `<option value="${y}" ${
                y === currentYear ? "selected" : ""
              }>${y}</option>`
          )
          .join("");
          
        const gradeOptions = allGrades.map(g => 
             `<option value="${g}" ${g === attendanceFilterGrade ? 'selected' : ''}>Grade ${g}</option>`
        ).join('');


        viewContainer.innerHTML = `
                <div class="space-y-6">
                    <p id="message" class="text-sm font-semibold h-5"></p>
                    
                    <!-- Month/Year Selector and Grade Filter -->
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
                            <h3 class="text-xl font-semibold text-indigo-700">Attendance Calendar</h3>
                            <div class="flex flex-wrap gap-2 items-center">
                                <select id="monthly-select-grade" class="p-2 border border-gray-300 rounded-lg shadow-sm w-32">
                                    ${gradeOptions}
                                </select>
                                <select id="monthly-select-month" class="p-2 border border-gray-300 rounded-lg shadow-sm w-32">
                                    ${monthOptions}
                                </select>
                                <select id="monthly-select-year" class="p-2 border border-gray-300 rounded-lg shadow-sm w-24">
                                    ${yearOptions}
                                </select>
                            </div>
                        </div>

                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200 mt-4">
                            <h4 class="text-md font-semibold text-indigo-700 mb-2">Monthly Quick Mark (Current View: Grade ${attendanceFilterGrade})</h4>
                            <div class="flex flex-wrap gap-3 items-center">
                                <button id="monthly-mark-btn" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 text-sm">
                                    Mark All Present (Grade ${attendanceFilterGrade})
                                </button>
                                <p class="text-xs text-indigo-500">Marks Sun-Fri as 'Present' for the selected grade. Overwrites existing data.</p>
                            </div>
                        </div>
                    </div>
                    <!-- END: Month/Year Selector and Quick Mark -->

                    <!-- Weekly Navigation -->
                    <div class="flex justify-between items-center px-4 md:px-0">
                        <button id="prev-week-btn" class="p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition disabled:opacity-50" ${prevButtonDisabled ? 'disabled' : ''}>
                            &larr; Prev Week
                        </button>
                        <span class="text-sm font-semibold text-gray-700">
                            ${viewStartDate.getDate()} - ${viewEndDate.getDate()}, ${viewStartDate.toLocaleString('default', { month: 'short' })}
                        </span>
                        <button id="next-week-btn" class="p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition disabled:opacity-50" ${nextButtonDisabled ? 'disabled' : ''}>
                            Next Week &rarr;
                        </button>
                    </div>

                    <!-- Monthly Attendance Calendar Table -->
                    <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-200 bg-white">
                        <table class="min-w-full text-sm text-left border-collapse">
                            <thead class="bg-indigo-600 text-white sticky top-0 z-10" id="monthly-attendance-header">
                                <tr>
                                    <!-- Sticky Columns -->
                                    <th scope="col" class="py-3 px-0 w-8 min-w-[32px] font-bold sticky-col-roll text-center">Roll</th>
                                    <th scope="col" class="py-3 px-1 w-24 min-w-[96px] font-bold sticky-col-name">Name</th>
                                    
                                    <!-- Weekly Day Headers -->
                                    ${(() => {
                                        let headers = '';
                                        const date = new Date(viewStartDate);
                                        for (let i = 0; i < 7; i++) {
                                            const dayIndex = date.getDay(); // 0=Sun, 6=Sat
                                            const dayNames = ["S", "M", "T", "W", "T", "F", "S"]; // Sun to Sat
                                            const dayName = dayNames[dayIndex];
                                            const isHoliday = date.getDay() === 6; // Saturday is Holiday
                                            
                                            headers += `<th scope="col" class="calendar-header-cell ${isHoliday ? "holiday" : ""}">
                                                            <div class="text-[0.6rem] font-normal">${dayName}</div>
                                                            <div class="text-xs font-bold">${date.getDate()}</div>
                                                        </th>`;
                                            date.setDate(date.getDate() + 1);
                                        }
                                        return headers;
                                    })()}
                                </tr>
                            </thead>
                            <tbody id="monthly-calendar-body" class="divide-y divide-gray-200">
                                <!-- Student rows injected here -->
                            </tbody>
                        </table>
                        <div id="no-students-message" class="text-center py-10 text-gray-500 hidden">
                             No students found for Grade ${attendanceFilterGrade}.
                        </div>
                    </div>
                </div>
            `;
        
        // --- NEW: Grade Filter Listener ---
        document
          .getElementById("monthly-select-grade")
          .addEventListener("change", (e) => {
              attendanceFilterGrade = e.target.value;
              weeklyViewOffset = 0; // Reset week view when changing grade/month
              renderMonthlyAttendance();
          });
          
        // Attach event listeners for month/year change
        document
          .getElementById("monthly-select-month")
          .addEventListener("change", window.updateMonthlyViewDate);
        document
          .getElementById("monthly-select-year")
          .addEventListener("change", window.updateMonthlyViewDate);
        document
          .getElementById("monthly-mark-btn")
          .addEventListener("click", window.handleMonthlyMark);
          
        // NEW: Weekly Navigation Listeners
        document.getElementById('prev-week-btn').addEventListener('click', () => {
            weeklyViewOffset--;
            renderMonthlyAttendance();
        });
        document.getElementById('next-week-btn').addEventListener('click', () => {
            weeklyViewOffset++;
            renderMonthlyAttendance();
        });


        // Attach click listener to the table body for cell updates (delegation)
        document
          .getElementById("monthly-calendar-body")
          .addEventListener("click", window.handleAttendanceCellClick);

        // Initial render of the calendar body
        renderMonthlyCalendarBody(viewStartDate, studentsForAttendance);
      }
      
      // Helper to handle month/year dropdown changes
      window.updateMonthlyViewDate = function() { // Made global
        const month = parseInt(
          document.getElementById("monthly-select-month").value
        );
        const year = parseInt(
          document.getElementById("monthly-select-year").value
        );
        monthlyViewDate = new Date(year, month - 1); // Month is 0-indexed in JS Date object
        weeklyViewOffset = 0; // Reset to the week containing the 1st of the month
        renderMonthlyAttendance(); // Re-render the entire view
      }

      // Helper to handle monthly mark button click
      window.handleMonthlyMark = function() { // Made global
        const month = parseInt(
          document.getElementById("monthly-select-month").value
        );
        const year = parseInt(
          document.getElementById("monthly-select-year").value
        );

        if (students.length === 0) {
          showMessage("Cannot mark: No students available.", "red");
          return;
        }

        const monthName = new Date(year, month - 1).toLocaleString("default", {
          month: "long",
        });
        console.log(
          `Confirmation required: Are you sure you want to mark ALL ${students.length} students as 'Present' for all school days (Sun-Fri) in ${monthName} ${year}? This will overwrite existing records.`
        );

        markMonthPresent(year, month);
      }

      // Helper to handle attendance cell clicks (toggle status)
      window.handleAttendanceCellClick = function(event) { // MADE GLOBAL
        const cell = event.target.closest(".attendance-mark");
        if (!cell || cell.classList.contains("holiday")) return; // check for .holiday class

        const studentId = cell.dataset.studentId;
        const date = cell.dataset.date;
        const currentStatus = cell.dataset.status;

        let newStatus;
        switch (currentStatus) {
          case "P":
            newStatus = "Absent";
            break;
          case "A":
            newStatus = "Late";
            break;
          case "L":
            newStatus = "PH";
            break; // Public Holiday
          case "PH":
            newStatus = "Unmarked";
            break; // Unmarked
          default:
            newStatus = "Present"; // If 'U' (Unmarked)
        }

        // Update Firestore
        setAttendanceRecord(studentId, date, newStatus);
        // UI update happens automatically via the global onSnapshot listener for allAttendanceRecords
      }

      // Primary function to populate the weekly calendar table
      function renderMonthlyCalendarBody(viewStartDate, studentsForAttendance) {
        const listBody = document.getElementById("monthly-calendar-body");
        const noStudentsMessage = document.getElementById(
          "no-students-message"
        );
        if (!listBody) return;

        listBody.innerHTML = "";

        if (studentsForAttendance.length === 0) {
          noStudentsMessage.classList.remove("hidden");
          return;
        }
        noStudentsMessage.classList.add("hidden");

        const datePrefix = monthlyViewDate.toISOString().slice(0, 7);

        // 1. Create a quick lookup map for attendance records in the current month
        const attendanceMap = allAttendanceRecords.reduce((acc, record) => {
          if (record.date.startsWith(datePrefix)) {
            if (!acc[record.studentId]) {
              acc[record.studentId] = {};
            }
            acc[record.studentId][record.date.slice(8, 10)] =
              record.status.charAt(0); // 'P', 'A', 'L', 'PH'
          }
          return acc;
        }, {});

        // 2. Build the table rows using the FILTERED student list
        studentsForAttendance.forEach((student) => {
          const row = document.createElement("tr");
          row.classList.add("hover:bg-gray-50", "transition", "duration-150");

          let cellsHtml = `
                    <td class="py-3 px-0 font-medium text-gray-900 sticky-col-roll text-center">${student.rollNo}</td>
                    <td class="py-3 px-1 text-gray-700 sticky-col-name">${student.name}</td>
                `;
          
          const date = new Date(viewStartDate);

          for (let i = 0; i < 7; i++) {
            const currentMonth = monthlyViewDate.getMonth();
            const cellMonth = date.getMonth();
            const dateStr = date.toISOString().slice(0, 10);
            const dayKey = String(date.getDate()).padStart(2, "0");
            const isHoliday = date.getDay() === 6; // Saturday is Holiday
            
            // Only show marks for the selected month, otherwise show a grayed out date or '--'
            let status = (cellMonth === currentMonth) ? (attendanceMap[student.id]?.[dayKey] || "U") : (isHoliday ? "-" : "U"); 
            let statusChar = isHoliday ? "-" : status;
            let statusClass = getStatusClasses(status);
            
            // If the date is outside the currently selected month, make it visually disabled
            const isOutsideMonth = cellMonth !== currentMonth;

            cellsHtml += `
                        <td class="calendar-cell attendance-mark border border-gray-100 ${statusClass} ${
              isHoliday ? "holiday" : ""
            } ${isOutsideMonth ? "opacity-50 pointer-events-none" : ""}" 
                            data-student-id="${student.id}" 
                            data-date="${dateStr}" 
                            data-status="${status}"
                            title="${dateStr} - ${student.name} - ${
              status === "U" ? "Unmarked" : status
            }">
                            ${statusChar}
                        </td>
                    `;
            date.setDate(date.getDate() + 1); // Move to the next day
          }

          row.innerHTML = cellsHtml;
          listBody.appendChild(row);
        });
      }


      // --- NEW: Helper function to render the Attendance Report Content ---
      function renderAttendanceReportContent(stats) {
          const studentRows = students
          .map((s) => {
            const sStats = stats.studentStats[s.id];
            
            // Get the calculated monthly and cumulative stats
            const presentThisMonth = sStats?.presentThisMonth || 0;
            const presentTillLastMonth = sStats?.presentTillLastMonth || 0;
            const totalPresent = presentThisMonth + presentTillLastMonth; // Sum of the two required columns
            const percentage = sStats?.percentage || 0;

            return `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-4 sm:px-6 font-medium text-gray-900">${
                          s.rollNo
                        }</td>
                        <td class="py-3 px-4 sm:px-6 text-gray-700">${
                          s.name
                        }</td>
                        <td class="py-3 px-4 text-center text-indigo-600 font-semibold">${presentThisMonth}</td>
                        <td class="py-3 px-4 text-center text-indigo-600 font-semibold">${presentTillLastMonth}</td>
                        <td class="py-3 px-4 text-center font-extrabold text-green-700">${totalPresent}</td>
                        <td class="py-3 px-4 font-bold text-center ${
                          percentage > 90
                            ? "text-green-600"
                            : percentage > 70
                            ? "text-yellow-600"
                            : "text-red-600"
                        }">${percentage.toFixed(1)}%</td>
                    </tr>
                `;
          })
          .join("");
          
          return `
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Present Month Attendance Rate</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${stats.globalPercentage.toFixed(
                          1
                        )}%</p>
                        <p class="text-xs text-gray-400">(${new Date().toLocaleString(
                          "default",
                          { month: "long", year: "numeric" }
                        )})</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Total Present (P + L)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${
                          stats.totalPresent + stats.totalLate
                        }</p>
                        <p class="text-xs text-gray-400">All recorded time.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Overall Attendance Rate</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${stats.globalPercentage.toFixed(
                          1
                        )}%</p>
                        <p class="text-xs text-gray-400">(${
                          stats.totalPresent + stats.totalLate
                        } / ${
          stats.totalPresent + stats.totalAbsent + stats.totalLate
        } expected records)</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700">Individual Student Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 font-bold text-gray-600">Roll No.</th>
                                    <th class="py-3 px-4 font-bold text-gray-600">Name</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">This Month (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Present Till Last Month (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Total Present (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Overall %</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${
                                  studentRows ||
                                  '<tr><td colspan="6" class="py-4 text-center text-gray-500">No student data to display.</td></tr>'
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
          `;
      }
      
      // --- NEW: Function to render the Exam Report Content ---
      function renderExamReportContent() {
          // New state to filter reports
          let reportGradeFilter = viewContainer.dataset.reportGradeFilter || 'All'; 
          
          // Filter exam records based on selected grade
          const filteredExamRecords = allExamRecords.filter(r => 
              reportGradeFilter === 'All' || (r.studentGrade && String(r.studentGrade).trim().toUpperCase() === reportGradeFilter.trim().toUpperCase())
          );
          
          // 1. Group records by exam batch (Subject, Type, Date)
          const examBatches = filteredExamRecords.reduce((acc, record) => {
              const key = record.examBatchId;
              if (!acc[key]) {
                  acc[key] = {
                      examBatchId: key, // Store ID for linking
                      subject: record.subject,
                      type: record.type,
                      date: record.date,
                      maxMarks: record.maxMarks,
                      totalScore: 0,
                      count: 0,
                      grade: record.studentGrade, // Added grade for display
                  };
              }
              acc[key].totalScore += record.score;
              acc[key].count++;
              return acc;
          }, {});

          const batchRows = Object.values(examBatches)
              .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
              .map(batch => {
                  const classAverage = batch.totalScore / batch.count;
                  const percentage = (classAverage / batch.maxMarks) * 100;
                  
                  // Ensure string parameters passed to onclick are correctly quoted and escaped
                  const onClickHandler = `deleteExamBatch('${batch.examBatchId}', '${batch.subject.replace(/'/g, "\\'")}', '${batch.type.replace(/'/g, "\\'")}')`;

                  return `
                      <tr class="bg-white hover:bg-gray-50 border-y border-gray-200">
                          <td class="py-3 px-4 font-medium text-gray-900">${batch.subject}</td>
                          <td 
                              class="py-3 px-4 text-gray-700 exam-batch-link" 
                              data-batch-id="${batch.examBatchId}"
                              onclick="openExamDetailsModal('${batch.examBatchId}')"
                          >
                              ${batch.type} (${batch.date})
                          </td>
                          <td class="py-3 px-4 text-center font-semibold">${batch.maxMarks}</td>
                          <td class="py-3 px-4 text-center">${batch.grade}</td>
                          <td class="py-3 px-4 text-center">${batch.count}</td>
                          <td class="py-3 px-4 text-center font-semibold text-indigo-600">${classAverage.toFixed(1)}</td>
                          <td class="py-3 px-4 text-center font-extrabold ${percentage >= 70 ? 'text-green-600' : 'text-red-600'}">${percentage.toFixed(1)}%</td>
                          <td class="py-3 px-4 text-center">
                              <button onclick="${onClickHandler}" 
                                      class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100" title="Delete Exam Batch">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                              </button>
                          </td>
                      </tr>
                  `;
              }).join('');
              
          // Grade options for the report filter
          const gradeFilterOptions = ['All', ...allGrades].map(g => 
              `<option value="${g}" ${g === reportGradeFilter ? 'selected' : ''}>${g === 'All' ? 'All Grades' : 'Grade ' + g}</option>`
          ).join('');

          return `
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-indigo-700">Exam Batch Summaries (Click Test Details)</h3>
                
                <div class="flex justify-end mb-4">
                    <label for="report-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Filter Grade:</label>
                    <select id="report-grade-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm">
                        ${gradeFilterOptions}
                    </select>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 font-bold text-gray-600">Subject</th>
                                <th class="py-3 px-4 font-bold text-gray-600">Test Details (Date)</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Max Marks</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Grade</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Students Marked</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Class Average Score</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Average %</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Delete</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${batchRows || '<tr><td colspan="8" class="py-4 text-center text-gray-500">No exam results found for this grade.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
          `;
          
          // Event Listener for the Grade Filter
          document.getElementById('report-grade-filter').addEventListener('change', (e) => {
              viewContainer.dataset.reportGradeFilter = e.target.value;
              renderView('reports');
          });
      }

      function renderReports() {
        const stats = calculateAttendanceStats();
        // Use a dataset attribute on the view container to maintain tab state across renders
        let currentReportTab = viewContainer.dataset.reportTab || 'attendance';

        const tabHtml = `
            <div class="space-y-6">
                <p class="text-xl font-medium text-gray-600">Detailed performance analysis.</p>
                <div class="mb-6">
                    <div class="flex space-x-4"> <!-- Changed to flex space-x-4 for pill style -->
                        <button 
                            data-tab="attendance" 
                            class="report-tab-btn report-tab-btn-style ${currentReportTab === 'attendance' ? 'active' : 'bg-gray-200 text-gray-700'}"
                        >
                            Attendance Records
                        </button>
                        <button 
                            data-tab="results" 
                            class="report-tab-btn report-tab-btn-style ${currentReportTab === 'results' ? 'active' : 'bg-gray-200 text-gray-700'}"
                        >
                            Exam Results
                        </button>
                    </div>
                    <div class="mt-4 h-1"></div> <!-- Spacer -->
                </div>
                <div id="report-tab-content">
                    <!-- Tab content loaded here -->
                </div>
            </div>
        `;

        viewContainer.innerHTML = tabHtml;
        
        // Render the correct content based on the active tab
        const contentEl = document.getElementById('report-tab-content');
        if (currentReportTab === 'attendance') {
            contentEl.innerHTML = renderAttendanceReportContent(stats);
        } else {
            contentEl.innerHTML = renderExamReportContent();
        }


        // Attach click listeners for tabs
        document.querySelectorAll('.report-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const newTab = e.target.dataset.tab;
                viewContainer.dataset.reportTab = newTab; // Save new state
                renderView('reports'); // Re-render the view to apply changes
            });
        });
      }
      
      // Function to handle grade selection in the exam input view
      window.handleExamGradeSelection = function(grade) {
          selectedExamGrade = grade;
          renderExamResults();
      }

      function renderExamResults() {
        if (students.length === 0) {
            viewContainer.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-lg text-center">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Exam Results</h3>
                    <p class="text-gray-600">Please add students in the **Student Management** section before entering exam scores.</p>
                </div>
            `;
            return;
        }

        const today = new Date().toISOString().slice(0, 10);
        
        // --- GRADE SELECTION OPTIONS ---
        const gradeOptions = ['Select Grade', ...allGrades].map(g => 
            `<option value="${g}" ${g === selectedExamGrade ? 'selected' : ''} ${g === 'Select Grade' ? 'disabled' : ''}>${g === 'Select Grade' ? g : 'Grade ' + g}</option>`
        ).join('');
        
        // --- Step 1: Grade Selection UI ---
        if (!selectedExamGrade || selectedExamGrade === 'Select Grade') {
             viewContainer.innerHTML = `
                <div class="max-w-md mx-auto p-8 bg-white rounded-xl shadow-lg text-center space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700">Select Grade for Scoring</h3>
                    <p class="text-gray-600">Choose the grade level you are currently entering exam scores for.</p>
                    <select id="exam-grade-selector" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm text-lg">
                        ${gradeOptions}
                    </select>
                </div>
             `;
             document.getElementById('exam-grade-selector').addEventListener('change', (e) => {
                 handleExamGradeSelection(e.target.value);
             });
             return;
        }
        
        // --- Step 2: Load Students and Scoring UI (Only runs if a grade is selected) ---
        // This relies on the FIXED getStudentsByGrade function
        const studentsForScoring = getStudentsByGrade(selectedExamGrade);
        
        const studentScoreRows = studentsForScoring.map(s => `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4 text-gray-900">${s.rollNo}</td>
                <td class="py-3 px-4 text-gray-700">${s.name}</td>
                <td class="py-3 px-4 text-gray-700">${s.grade || 'N/A'}</td>
                <td class="py-3 px-4">
                    <input type="number" step="0.1" data-id="${s.id}" class="score-input w-24 p-1 border border-gray-300 rounded-md text-center focus:ring-indigo-500 focus:border-indigo-500" placeholder="Score">
                </td>
            </tr>
        `).join('');

        viewContainer.innerHTML = `
            <div class="space-y-6">
                <p id="message" class="text-sm font-semibold h-5"></p>
                
                <!-- Currently Selected Grade Display -->
                <div class="bg-indigo-50 p-3 rounded-xl shadow-inner border border-indigo-200 flex justify-between items-center">
                    <h4 class="text-lg font-bold text-indigo-800">Entering Scores for: Grade ${selectedExamGrade}</h4>
                    <button onclick="handleExamGradeSelection('')" class="text-sm text-indigo-600 hover:text-indigo-900 font-semibold underline">
                        Change Grade
                    </button>
                </div>

                <!-- Exam Details Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Exam Details</h3>
                    <form id="exam-details-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="exam-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                                <input type="text" id="exam-subject" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-type" class="block text-sm font-medium text-gray-700">Test Type</label>
                                <input type="text" id="exam-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-max-marks" class="block text-sm font-medium text-gray-700">Max Marks</label>
                                <input type="number" id="exam-max-marks" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-date" class="block text-sm font-medium text-gray-700">Exam Date</label>
                                <input type="date" id="exam-date" value="${today}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Score Entry Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Student Scores (${studentsForScoring.length} Students)</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Roll No.</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-2/5">Student Name</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Grade</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Marks Scored</th>
                                </tr>
                            </thead>
                            <tbody id="student-score-list" class="divide-y divide-gray-200">
                                ${studentScoreRows}
                            </tbody>
                        </table>
                    </div>
                    <button id="save-scores-btn" class="mt-6 w-full px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                        Save Exam Results
                    </button>
                </div>
            </div>
        `;

        // Add event listener for saving scores
        document.getElementById('save-scores-btn').addEventListener('click', () => {
            const subject = document.getElementById('exam-subject').value.trim();
            const type = document.getElementById('exam-type').value.trim(); 
            const maxMarks = document.getElementById('exam-max-marks').value;
            const date = document.getElementById('exam-date').value;

            if (!subject || !type || !maxMarks || !date) {
                showMessage("Please fill in all Exam Details (Subject, Type, Max Marks, Date).", "red");
                return;
            }

            const scoreInputs = document.querySelectorAll('.score-input');
            const scores = {};
            
            let allScoresValid = true;
            scoreInputs.forEach(input => {
                const studentId = input.dataset.id;
                const scoreValue = input.value.trim();
                
                if (scoreValue !== "") {
                    const scoreNum = parseFloat(scoreValue);
                    const maxNum = parseInt(maxMarks);
                    
                    if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > maxNum) {
                        allScoresValid = false;
                        input.classList.add('border-red-500', 'ring-red-500');
                        input.focus();
                    } else {
                         input.classList.remove('border-red-500', 'ring-red-500');
                         scores[studentId] = scoreNum;
                    }
                }
            });

            if (!allScoresValid) {
                 showMessage(`One or more scores are invalid. They must be between 0 and ${maxMarks}.`, "red");
                 return;
            }

            if (Object.keys(scores).length === 0) {
                 showMessage("Please enter at least one score.", "red");
                 return;
            }

            saveExamResults(subject, type, maxMarks, date, scores);
        });
      }
      
      // --- MODAL FUNCTIONS ---
      
      // Function to close any modal
      window.closeModal = function(modalId) {
          document.getElementById(modalId).classList.add('hidden');
      }

      // Function to open the exam details modal and populate with batch data
      window.openExamDetailsModal = function(batchId) {
          const batchRecords = allExamRecords.filter(r => r.examBatchId === batchId);
          
          if (batchRecords.length === 0) {
              showMessage("No detailed records found for this exam batch.", "red");
              return;
          }

          // All records in the batch share the same exam details
          const examDetails = batchRecords[0];
          const maxMarks = examDetails.maxMarks;

          // Populate Modal Header
          document.getElementById('modal-title').innerHTML = 
              `${examDetails.subject} - ${examDetails.type} <span class="text-sm font-normal text-gray-500">(Max Marks: ${maxMarks})</span>`;

          // Generate student results table content
          const studentResults = batchRecords
              .map(record => {
                  const percentage = (record.score / maxMarks) * 100;
                  const rollNo = students.find(s => s.id === record.studentId)?.rollNo || 'N/A';
                  
                  return `
                      <tr class="hover:bg-gray-50">
                          <td class="py-2 px-4 font-medium">${rollNo}</td>
                          <td class="py-2 px-4">${record.studentName}</td>
                          <td class="py-2 px-4">${record.studentGrade || 'N/A'}</td>
                          <td class="py-2 px-4 text-center text-lg font-bold">${record.score}</td>
                          <td class="py-2 px-4 text-center font-semibold ${percentage >= 70 ? 'text-green-600' : 'text-red-600'}">${percentage.toFixed(1)}%</td>
                      </tr>
                  `;
              }).join('');
              
          const modalContentHtml = `
              <p class="text-sm text-gray-600 mb-4">Exam Date: ${examDetails.date}</p>
              <div class="overflow-x-auto max-h-[60vh] border rounded-lg">
                  <table class="min-w-full text-sm divide-y divide-gray-200">
                      <thead class="bg-gray-50 sticky top-0">
                          <tr>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-1/6">Roll No.</th>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-3/6">Student Name</th>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-1/6">Grade</th>
                              <th class="py-3 px-4 text-center text-xs font-bold text-gray-600 uppercase w-1/6">Score</th>
                              <th class="py-3 px-4 text-center text-xs font-bold text-gray-600 uppercase w-1/6">Percentage</th>
                          </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                          ${studentResults}
                      </tbody>
                  </table>
              </div>
          `;
          
          document.getElementById('modal-content').innerHTML = modalContentHtml;
          examDetailsModal.classList.remove('hidden');
      }


      // --- INITIALIZATION & LISTENERS ---

      // 3. Navigation Listener (Handles both Mobile and Desktop Clicks)
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const view = e.currentTarget.dataset.view;
          renderView(view);
        });
      });
      
      // Close modal on escape key press
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              if (!examDetailsModal.classList.contains('hidden')) {
                  closeModal('exam-details-modal');
              }
              if (!editStudentModal.classList.contains('hidden')) {
                  closeModal('edit-student-modal');
              }
          }
      });
      
      // Close modal when clicking outside the modal content area
      [examDetailsModal, editStudentModal].forEach(modal => {
          modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                  closeModal(modal.id);
              }
          });
      });


      // 6. Initial Load: Call the initialization function when the window loads
      window.onload = function () {
        initializeFirebase();
      };
    </script>
  </body >
</html>
