<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Attendance Hub</title>
    <!-- Load Tailwind CSS CDN - FIXED version to a stable 3.4.17 -->
    <script src="https://cdn.tailwindcss.com?version=3.4.17"></script>
    <style>
      /* Custom styles for status badges */
      .status-badge {
        padding: 4px 8px;
        border-radius: 9999px;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }
      /* Style for the main content area to allow scrolling */
      .main-content {
        /* On desktop (md and up), use full height minus header/footer */
        min-height: calc(100vh - 4rem); 
        /* On mobile (sm and down), add bottom padding equal to the height of the fixed mobile nav bar (56px) */
        padding-bottom: 56px !important;
      }
      /* Utility for active sidebar link */
      .active-nav {
        background-color: #4f46e5;
        color: white;
      }
      /* Style for the calendar cell */
      .calendar-cell {
        width: 40px; /* Fixed width for date columns */
        min-width: 40px;
        height: 40px;
        text-align: center;
        padding: 0;
        cursor: pointer;
        transition: background-color 0.1s;
        font-size: 0.75rem; /* text-xs */
        font-weight: 600;
        line-height: 1; /* Adjust line height for the two lines of text */
      }
      .calendar-cell:hover:not(.day-header):not(.holiday) {
        background-color: #e5e7eb; /* gray-200 */
      }
      .holiday {
        background-color: #f3f4f6; /* gray-100 */
        color: #9ca3af; /* gray-400 */
      }
      .status-P {
        background-color: #10b981;
        color: white;
      } /* Emerald-500 (Present) */
      .status-A {
        background-color: #ef4444;
        color: white;
      } /* Red-500 (Absent) */
      .status-L {
        background-color: #f59e0b;
        color: white;
      } /* Amber-500 (Late) */
      .status-PH {
        background-color: #3b82f6;
        color: white;
      } /* Blue-500 (Public Holiday) */
      .status-U {
        background-color: #9ca3af;
        color: white;
      } /* Gray-400 (Unknown/Unmarked) */
      
      /* New style for the mobile bottom nav items */
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4px 0;
        font-size: 0.6rem; /* text-[0.6rem] */
        line-height: 1;
        text-align: center;
        width: 20%;
        transition: color 0.15s;
      }
      .mobile-active-nav {
          color: #4f46e5; /* indigo-600 */
      }
      /* Hide regular sidebar on small screens */
      @media (max-width: 767px) {
          #sidebar {
              /* Remove absolute positioning to hide it completely */
              display: none !important;
          }
          /* Ensure content area uses full width on mobile */
          .main-content {
            padding-left: 1rem;
            padding-right: 1rem;
          }
      }
      
      /* New Card Styles for Dashboard */
      .metric-card {
          display: flex;
          align-items: center;
          padding: 1.5rem;
          background-color: white;
          border-radius: 0.75rem;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: transform 0.1s;
      }
      .metric-card:hover {
          transform: translateY(-2px);
      }
      .icon-container {
          padding: 0.75rem;
          border-radius: 9999px;
          color: white;
          margin-right: 1rem;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      .metric-value {
          font-size: 1.875rem; /* text-3xl */
          font-weight: 700; /* font-bold */
          line-height: 1;
      }
      .metric-label {
          font-size: 0.875rem; /* text-sm */
          font-weight: 500; /* font-medium */
          color: #6b7280; /* gray-500 */
      }
      /* Style for sticky table headers/columns */
      .sticky-col-roll {
          position: sticky;
          left: 0;
          background-color: #4f46e5; /* indigo-600 */
          z-index: 10;
          box-shadow: 2px 0 2px -2px rgba(0,0,0,0.2);
          padding-left: 0.25rem; /* p-1 */
          padding-right: 0.25rem; /* p-1 */
      }
      .sticky-col-name {
          position: sticky;
          left: 32px; /* Width of roll column (32px) */
          background-color: #4f46e5; /* indigo-600 */
          z-index: 10;
          box-shadow: 2px 0 2px -2px rgba(0,0,0,0.2);
          padding-left: 0.5rem; /* p-2 */
          padding-right: 0.5rem; /* p-2 */
          width: 96px; /* 96px width */
          min-width: 96px;
          max-width: 96px;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      /* Apply sticky background override for body cells too */
      #monthly-calendar-body .sticky-col-roll {
          background-color: white;
          color: #1f2937; /* gray-800 */
          font-weight: 500;
          z-index: 5;
      }
       #monthly-calendar-body .sticky-col-name {
          background-color: white;
          color: #374151; /* gray-700 */
          z-index: 5;
      }
      .calendar-header-cell {
        width: 40px;
        min-width: 40px;
        padding: 0;
      }
      /* Custom style for Top Student lists */
      .top-student-list li {
          display: flex;
          justify-content: space-between;
          padding: 0.5rem 0;
          border-bottom: 1px dashed #e5e7eb;
          font-size: 0.9rem;
      }
      .top-student-list li:last-child {
          border-bottom: none;
      }
      .student-rank {
          font-weight: 700;
          color: #4f46e5;
          margin-right: 0.5rem;
          min-width: 20px;
          text-align: center;
      }
      .student-value {
          font-weight: 600;
      }
    </style>
  </head>
  <body class="bg-gray-100 antialiased">
    <!-- Main Container -->
    <div class="flex h-screen overflow-hidden">
      <!-- Desktop Sidebar (Visible on md and up) -->
      <div
        id="sidebar"
        class="hidden md:flex w-64 bg-indigo-800 text-white flex-shrink-0 transition-all duration-300 transform md:relative z-20 shadow-xl flex-col justify-between"
      >
        <div>
          <div class="p-6">
            <h2 class="text-2xl font-bold border-b border-indigo-700 pb-3 mb-6">
              Attendance Hub
            </h2>
            <nav>
              <!-- Menu Items (Desktop Only) -->
              <a
                href="#"
                data-view="dashboard"
                class="menu-item flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700 active-nav"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                  ></path>
                </svg>
                Dashboard
              </a>
              <a
                href="#"
                data-view="students"
                class="menu-item flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m11.115-7.443-2.289-.968A3.003 3.003 0 0015 10a3 3 0 00-2.356-1.185l-2.29-.968C9.55 7.14 8.789 7 8 7V6c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v1c.789 0 1.55.14 2.228.455l2.289.968A3.003 3.003 0 0121 12a3.003 3.003 0 01-2.356 2.815l-2.289.968m-14.777-6.002C5.972 8.358 6 9.176 6 10c0 1.831-.502 3.513-1.398 4.87C4.156 15.659 3.197 16.5 2 16.5"
                  ></path>
                </svg>
                Student Management
              </a>
              <a
                href="#"
                data-view="attendance"
                class="menu-item flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                Monthly Attendance
              </a>
              <a
                href="#"
                data-view="reports"
                class="menu-item flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"
                  ></path>
                </svg>
                Reports
              </a>
              <a
                href="#"
                data-view="exams"
                class="menu-item flex items-center p-3 rounded-lg mb-2 transition duration-150 hover:bg-indigo-700"
              >
                <svg
                  class="w-5 h-5 mr-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Exam Results
              </a>
            </nav>
          </div>
        </div>
        <!-- User Info (Auth Status) - Desktop Only -->
        <div class="p-4 border-t border-indigo-700 w-full">
          <p id="user-status" class="text-sm">Status: Initializing...</p>
          <p id="user-id-display" class="text-xs break-all mt-1 opacity-70"></p>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col overflow-auto p-4 sm:p-8 main-content">
        <header class="h-16 flex items-center justify-end md:justify-start">
          <h1 id="view-title" class="text-3xl font-bold text-gray-800">
            Dashboard
          </h1>
        </header>

        <!-- Main View Container -->
        <div id="view-container" class="flex-1 mt-4">
          <!-- Content will be injected here -->
        </div>

        <footer class="mt-8 pt-4 text-center text-gray-500 text-sm md:border-t hidden md:block">
          Designed By Rakesh Kadel
        </footer>
      </div>

      <!-- Mobile Bottom Navigation Bar (Visible only on sm and below) -->
      <div id="mobile-nav" class="fixed bottom-0 left-0 right-0 h-14 bg-white border-t border-gray-200 shadow-xl flex justify-around items-center z-30 md:hidden">
            <a href="#" data-view="dashboard" class="menu-item mobile-nav-item text-gray-500 mobile-active-nav">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Dashboard
            </a>
            <a href="#" data-view="students" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m11.115-7.443-2.289-.968A3.003 3.003 0 0015 10a3 3 0 00-2.356-1.185l-2.29-.968C9.55 7.14 8.789 7 8 7V6c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v1c.789 0 1.55.14 2.228.455l2.289.968A3.003 3.003 0 0121 12a3.003 3.003 0 01-2.356 2.815l-2.289.968m-14.777-6.002C5.972 8.358 6 9.176 6 10c0 1.831-.502 3.513-1.398 4.87C4.156 15.659 3.197 16.5 2 16.5"></path></svg>
                Students
            </a>
            <a href="#" data-view="attendance" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Attendance
            </a>
            <a href="#" data-view="reports" class="menu-item mobile-nav-item text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path></svg>
                Reports
            </a>
            <a href="#" data-view="exams" class="menu-item mobile-nav-item text-gray-500">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Exams
            </a>
            <div class="mobile-nav-item" id="mobile-status-container">
                <p class="text-[0.6rem] text-gray-400">Status:</p>
                <p id="mobile-user-status" class="text-[0.6rem] font-semibold text-gray-500">...</p>
            </div>
      </div>
    </div>
    
    <!-- MODAL 1: Exam Details Modal Container (Hidden by default) -->
    <div id="exam-details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-indigo-700">Exam Results Details</h3>
                <button onclick="closeModal('exam-details-modal')" class="text-gray-500 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Detailed results table will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- MODAL 2: Student Edit Modal Container (Hidden by default) -->
    <div id="edit-student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <form id="edit-student-form">
                <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                    <h3 class="text-xl font-bold text-indigo-700">Edit Student Details</h3>
                    <button type="button" onclick="closeModal('edit-student-modal')" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-student-id">
                    <div>
                        <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                        <input type="text" id="edit-student-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-student-rollno" class="block text-sm font-medium text-gray-700">Roll No. (ID)</label>
                        <input type="number" id="edit-student-rollno" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-student-grade" class="block text-sm font-medium text-gray-700">Grade Level</label>
                        <input type="text" id="edit-student-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <p id="edit-student-message" class="text-sm font-semibold h-5"></p>
                </div>
                <div class="p-6 border-t bg-gray-50 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('edit-student-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase Imports -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        collection,
        onSnapshot,
        addDoc,
        deleteDoc,
        query,
        orderBy,
        setDoc,
        updateDoc, // <-- ADDED
        where,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global Firebase Variables (Mandatory Canvas Setup)
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      // FIX: Use robust checks to provide an empty object/null if the string is undefined or empty.
      const firebaseConfig =
        (typeof __firebase_config !== "undefined" && __firebase_config)
          ? JSON.parse(__firebase_config)
          : null;
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let db, auth; // Declare Firebase instances globally
      let students = []; // Holds all student records
      let allAttendanceRecords = []; // Holds all attendance records for reporting
      let allExamRecords = []; // **NEW: Holds all exam records**
      let currentView = "dashboard";
      let userId = null;
      let monthlyViewDate = new Date(); // Tracks the currently viewed month/year
      let weeklyViewOffset = 0; // Tracks the current week offset (0 = current week)

      // --- GRADE MANAGEMENT STATE ---
      let allGrades = []; // Array of unique grades (e.g., ['9', '10A', '7B'])
      let attendanceFilterGrade = '7B'; // **DEFAULT GRADE for Attendance View**
      let selectedExamGrade = ''; // Grade currently selected in the Exam Results INPUT form


      // DOM Elements
      const viewContainer = document.getElementById("view-container");
      const viewTitle = document.getElementById("view-title");
      const userStatusEl = document.getElementById("user-status"); // Desktop status
      const userIdDisplayEl = document.getElementById("user-id-display"); // Desktop User ID
      const mobileUserStatusEl = document.getElementById("mobile-user-status"); // Mobile status
      const examDetailsModal = document.getElementById('exam-details-modal');
      const editStudentModal = document.getElementById('edit-student-modal'); // **NEW**


      // --- FIREBASE INITIALIZATION ---

      function initializeFirebase() {
        if (!firebaseConfig) {
          console.error("Firebase configuration is missing.");
          userStatusEl.textContent = "Error: Config Missing.";
          mobileUserStatusEl.textContent = "Error!";
          // Render the view, which will now use the safer approach for missing config
          renderView("dashboard");
          return;
        }
        
        // Ensure the config is not an empty object that failed parsing earlier
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is empty or malformed.");
            userStatusEl.textContent = "Error: Config Empty.";
            mobileUserStatusEl.textContent = "Error!";
            renderView("dashboard");
            return;
        }


        console.log("[DIAGNOSTIC] Attempting Firebase Initialization...");
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        setLogLevel("Debug");

        // Set up Authentication Listener
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userStatusEl.textContent = "Status: Connected";
            mobileUserStatusEl.textContent = "Connected";
            userIdDisplayEl.textContent = `User ID: ${userId}`;

            // Once authenticated, start listening for data
            setupDataListeners();
          } else {
            handleAuth();
          }
        });

        renderView("dashboard");
      }

      // --- FIREBASE PATHS & FUNCTIONS ---

      const getStudentCollectionRef = () =>
        collection(db, "artifacts", appId, "public", "data", "students");
      const getAttendanceCollectionRef = () =>
        collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "attendance_records"
        );
      const getExamCollectionRef = () =>
        collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "exam_results"
        );


      async function handleAuth() {
        if (!db || !auth) return; // Guard against uninitialized Firebase
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            // Sign in anonymously for public data access
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Firebase Auth Error:", error);
          userStatusEl.textContent = "Status: Auth Error!";
          mobileUserStatusEl.textContent = "Auth Error!";
        }
      }

      async function addStudent(name, rollNo, grade) {
        if (!userId || !db) {
          console.error("User not authenticated or Database not ready.");
          showMessage("Error: Database not ready.", "red");
          return;
        }
        try {
          // Normalize grade before saving to ensure consistent filtering later
          const normalizedGrade = grade.trim().toUpperCase(); 
          
          await addDoc(getStudentCollectionRef(), {
            name: name,
            rollNo: rollNo,
            grade: normalizedGrade, // <-- SAVED: Normalized Grade Level
            createdAt: new Date(),
          });
          showMessage(`Student ${name} (Grade ${normalizedGrade}) added successfully!`, "green");
        } catch (e) {
          console.error("Error adding student: ", e);
          showMessage("Error adding student.", "red");
        }
      }
      
      // **NEW: Update Student Function**
      window.updateStudentDetails = async function(id, name, rollNo, grade) {
        if (!userId || !db) {
          showMessage("Error: Database not ready.", "red");
          return;
        }
        try {
            // Normalize grade before saving
            const normalizedGrade = grade.trim().toUpperCase();
            
            const studentRef = doc(getStudentCollectionRef(), id);
            await updateDoc(studentRef, {
                name: name,
                rollNo: rollNo,
                grade: normalizedGrade,
            });
            showMessage(`Student ${name} details updated successfully!`, "green");
            closeModal('edit-student-modal');
        } catch (e) {
            console.error("Error updating student: ", e);
            showMessage("Error updating student details.", "red");
        }
      }

      async function deleteStudent(id) {
        if (!userId || !db) {
          console.error("User not authenticated or Database not ready.");
          showMessage("Error: Database not ready.", "red");
          return;
        }
        try {
          await deleteDoc(doc(getStudentCollectionRef(), id));
          showMessage("Student deleted successfully!", "green");
        } catch (e) {
          console.error("Error deleting student: ", e);
          showMessage("Error deleting student.", "red");
        }
      }

      // Function to set or update a single attendance record
      async function setAttendanceRecord(studentId, date, status) {
        if (!userId || !db) return;
        const docId = `${studentId}_${date}`;
        const attendanceRef = doc(getAttendanceCollectionRef(), docId);

        try {
          await setDoc(
            attendanceRef,
            {
              studentId: studentId,
              date: date,
              status: status,
              timestamp: new Date(),
            },
            { merge: true }
          );
          // UI update happens automatically via the global onSnapshot listener for allAttendanceRecords
        } catch (e) {
          console.error("Error setting attendance record: ", e);
          showMessage("Error saving attendance mark.", "red");
        }
      }

      async function markMonthPresent(year, month) {
        // Filter students based on current attendance filter grade
        const studentsToMark = getStudentsByGrade(attendanceFilterGrade);

        if (!userId || studentsToMark.length === 0 || !db) {
          showMessage(
            "Error: Database not ready or no students available in the current grade.",
            "red"
          );
          return;
        }

        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0);
        const daysInMonth = endDate.getDate();
        const monthName = startDate.toLocaleString("default", {
          month: "long",
        });

        let batch = writeBatch(db);
        let totalRecords = 0;

        for (let day = 1; day <= daysInMonth; day++) {
          const currentDate = new Date(year, month - 1, day);
          const dateStr = formatDateLocal(currentDate); // **FIXED: Use local format for saving**

          const dayOfWeek = currentDate.getDay(); // 0=Sun, 6=Sat

          // Only skip Saturday (6) - School is Sun-Fri
          if (dayOfWeek === 6) {
            continue;
          }

          studentsToMark.forEach((student) => {
            const docId = `${student.id}_${dateStr}`;
            const attendanceRef = doc(getAttendanceCollectionRef(), docId);

            batch.set(
              attendanceRef,
              {
                studentId: student.id,
                date: dateStr,
                status: "Present",
                timestamp: new Date(),
              },
              { merge: true }
            );
            totalRecords++;

            if (totalRecords % 490 === 0) {
              console.log(`Committing intermediate batch...`);
              batch.commit();
              batch = writeBatch(db);
            }
          });
        }

        try {
          await batch.commit();
          showMessage(
            `Successfully marked ${studentsToMark.length} students in Grade ${attendanceFilterGrade} Present for all school days (Sun-Fri) in ${monthName} ${year}. Total records processed: ${totalRecords}.`,
            "green"
          );
        } catch (e) {
          console.error("Batch write error during monthly mark: ", e);
          showMessage("Error marking monthly attendance. Check console for details.", "red");
        }
      }

      async function saveExamResults(subject, type, maxMarks, date, scores) {
        if (!userId || !db) {
          showMessage("Error: Database not ready.", "red");
          return;
        }
        if (students.length === 0) {
          showMessage("Error: No students to score.", "red");
          return;
        }

        // Generate a unique ID for this exam batch
        const examBatchId = `${subject}_${type}_${date}`.replace(/\s/g, '_');
        
        let batch = writeBatch(db);
        let validScores = 0;

        students.forEach(student => {
            const score = scores[student.id];
            
            // Find the student's full data object to get the grade
            const studentData = students.find(s => s.id === student.id);
            // Grade is already normalized in the student object
            const studentGrade = studentData?.grade || 'UNKNOWN'; 

            // Only save if a score was entered
            if (score !== undefined && score !== null && score !== "") {
                const docId = `${examBatchId}_${student.id}`;
                const examRef = doc(getExamCollectionRef(), docId);
                
                batch.set(examRef, {
                    examBatchId: examBatchId,
                    studentId: student.id,
                    studentName: student.name,
                    studentGrade: studentGrade, // <-- SAVED: Normalized Grade
                    subject: subject,
                    type: type,
                    date: date,
                    maxMarks: parseInt(maxMarks),
                    score: parseFloat(score),
                    timestamp: new Date(),
                });
                validScores++;
            }
        });

        if (validScores === 0) {
            showMessage("Please enter at least one student's score to save the results.", "red");
            return;
        }

        try {
            await batch.commit();
            showMessage(`Successfully saved results for ${validScores} students for ${subject} (${type}).`, "green");
            // Optionally clear the form or reset the view
            renderExamResults(); 
        } catch (e) {
            console.error("Batch write error during exam results save: ", e);
            showMessage("Error saving exam results. Check console.", "red");
        }
      }
      
      // --- FIX: Updated Function to delete an entire Exam Batch ---
      window.deleteExamBatch = async function(batchId, subject, type) {
          console.log(`[DELETE] Attempting to delete batch ID: ${batchId}`);
          
          if (!userId || !db) {
              showMessage("Error: Database not ready.", "red");
              console.error("[DELETE] Error: Database not ready.");
              return;
          }
          
          if (confirm(`Are you sure you want to permanently delete ALL results for the exam: ${subject} - ${type}? This action cannot be undone.`)) {
              
              const recordsToDelete = allExamRecords.filter(r => r.examBatchId === batchId);
              
              if (recordsToDelete.length === 0) {
                  showMessage("Error: No records found for this batch.", "red");
                  console.warn(`[DELETE] Warning: No records found in cache for batch ID: ${batchId}`);
                  return;
              }
              
              console.log(`[DELETE] Found ${recordsToDelete.length} records. Starting batch write deletion.`);

              let batch = writeBatch(db);
              recordsToDelete.forEach(record => {
                  const docRef = doc(getExamCollectionRef(), record.id);
                  batch.delete(docRef);
                  console.log(`[DELETE] Queued document for deletion: ${record.id}`);
              });
              
              try {
                  await batch.commit();
                  showMessage(`Successfully deleted ${recordsToDelete.length} records for ${subject} - ${type}.`, "green");
                  console.log(`[DELETE] Batch commit successful.`);
                  // The onSnapshot listener will handle the UI update automatically
              } catch (e) {
                  console.error("[DELETE] Error deleting exam batch:", e);
                  showMessage("Error deleting exam records. Check console.", "red");
              }
          } else {
               console.log("[DELETE] Deletion cancelled by user.");
          }
      }

      // --- DATA LISTENERS ---

      function setupDataListeners() {
        if (!userId || !db) return;

        // 1. Student Listener
        const qStudents = getStudentCollectionRef();
        onSnapshot(
          qStudents,
          (snapshot) => {
            const newStudents = [];
            snapshot.forEach((doc) => {
              newStudents.push({ id: doc.id, ...doc.data() });
            });
            students = newStudents.sort((a, b) => a.rollNo - b.rollNo); // Keep sorted

            // Calculate unique grades
            const gradesSet = new Set(newStudents.map(s => s.grade).filter(Boolean).map(g => g.trim().toUpperCase()));
            // Keep allGrades list capitalized and sorted for UI selectors
            allGrades = Array.from(gradesSet).sort(); 
            
            // If the default filter grade is no longer valid, reset it.
            if (!allGrades.includes(attendanceFilterGrade)) {
                attendanceFilterGrade = allGrades[0] || '';
            }


            // Re-render the current view to reflect new student list/stats
            renderView(currentView);
          },
          (error) => {
            console.error("Error fetching students:", error);
            showMessage("Could not load student list.", "red");
          }
        );

        // 2. All Attendance Listener (for comprehensive reports/dashboard)
        const qAttendance = getAttendanceCollectionRef();

        onSnapshot(
          qAttendance,
          (snapshot) => {
            allAttendanceRecords = [];
            snapshot.forEach((doc) => {
              allAttendanceRecords.push({ id: doc.id, ...doc.data() });
            });

            // Re-render reports/dashboard immediately when attendance changes
            if (
              currentView === "dashboard" ||
              currentView === "reports" ||
              currentView === "attendance"
            ) {
              renderView(currentView);
            }
          },
          (error) => {
            console.error("Error fetching all attendance records:", error);
          }
        );
        
        // 3. All Exam Results Listener (NEW)
        const qExams = getExamCollectionRef();
        onSnapshot(
          qExams,
          (snapshot) => {
            allExamRecords = [];
            snapshot.forEach((doc) => {
              allExamRecords.push({ id: doc.id, ...doc.data() });
            });

            if (currentView === "reports" || currentView === "students" || currentView === "exams" || currentView === "dashboard") { 
              renderView(currentView); 
            }
          },
          (error) => {
            console.error("Error fetching exam records:", error);
          }
        );
      }
      
      // --- HELPER FUNCTIONS ---

      // **FIXED**: Helper function to ensure YYYY-MM-DD format using local time components
      function formatDateLocal(date) {
          const year = date.getFullYear();
          // Month is 0-indexed in JS Date, so +1
          const month = String(date.getMonth() + 1).padStart(2, '0'); 
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }
      
      // **FIXED**: Normalizes both the filter grade and the student's grade for reliable matching.
      function getStudentsByGrade(grade) {
          const normalizedFilter = grade ? grade.trim().toUpperCase() : null;
          
          if (!normalizedFilter || normalizedFilter === 'ALL' || normalizedFilter === 'UNASSIGNED') return students;
          
          return students.filter(s => {
              // Ensure student.grade exists and normalize it for comparison
              const normalizedStudentGrade = s.grade ? String(s.grade).trim().toUpperCase() : 'UNKNOWN';
              return normalizedStudentGrade === normalizedFilter;
          });
      }

      // --- DATA CALCULATION ---

      function calculateAttendanceStats() {
        const stats = {
          totalStudents: students.length,
          totalAttendanceDays: 0,
          totalPresent: 0, // Total P marks (raw count)
          totalAbsent: 0, // Total A marks (raw count)
          totalLate: 0, // Total L marks (raw count)
          totalPublicHolidays: 0,
          totalPresentUntilLastMonth: 0,
          studentStats: {}, // {studentId: {present, absent, late, publicHoliday, percentage, presentThisMonth, presentTillLastMonth}}
        };

        const daySet = new Set();
        const today = new Date();
        const currentMonthPrefix = formatDateLocal(today).slice(0, 7); // **FIXED: Use local formatter**

        students.forEach((s) => {
          stats.studentStats[s.id] = {
            present: 0,
            absent: 0,
            late: 0,
            publicHoliday: 0,
            totalMarkedDays: 0,
            percentage: 0,
            presentThisMonth: 0, 
            presentTillLastMonth: 0,
            overallAttendancePercent: 0, // NEW: Attendance percentage for dashboard
          };
        });

        allAttendanceRecords.forEach((record) => {
          daySet.add(record.date);
          const studentId = record.studentId;
          const status = record.status;
          const recordDate = record.date;
          const recordDatePrefix = recordDate.slice(0, 7);

          if (stats.studentStats[studentId]) {
            const studentStat = stats.studentStats[studentId];
            studentStat.totalMarkedDays++;

            const isPresentOrLate = status === "Present" || status === "Late";
            const isLastMonthOrEarlier = recordDatePrefix !== currentMonthPrefix;

            if (status === "Present") {
              stats.totalPresent++;
              studentStat.present++;
            } else if (status === "Absent") {
              stats.totalAbsent++;
              studentStat.absent++;
            } else if (status === "Late") {
              stats.totalLate++;
              studentStat.late++;
            } else if (status === "PH") {
              stats.totalPublicHolidays++;
              studentStat.publicHoliday++;
            }

            // Calculate present counts for reporting columns
            if (isPresentOrLate) {
                if (isLastMonthOrEarlier) {
                    studentStat.presentTillLastMonth++;
                    stats.totalPresentUntilLastMonth++;
                } else {
                    studentStat.presentThisMonth++;
                }
            }
          }
        });

        stats.totalAttendanceDays = daySet.size;

        // Calculate student percentages and global percentage
        let totalExpectedMarks = 0; // P + A + L (excluding PH) 
        let totalActualPresent = 0; // P + L

        students.forEach((s) => {
          const studentStat = stats.studentStats[s.id];
          if (studentStat) {
            const expectedMarks =
              studentStat.present + studentStat.absent + studentStat.late;
            totalExpectedMarks += expectedMarks;
            totalActualPresent += studentStat.present + studentStat.late;
            
            // Total Present is the sum of all P + L
            studentStat.totalPresent = studentStat.present + studentStat.late;

            if (expectedMarks > 0) {
              // Percentage is (Present + Late) / (Present + Absent + Late)
              const percentage =
                ((studentStat.present + studentStat.late) / expectedMarks) *
                100;
              studentStat.percentage = percentage;
              studentStat.overallAttendancePercent = percentage; // Use this for dashboard ranking
            } else {
                studentStat.overallAttendancePercent = 0;
            }
          }
        });

        stats.globalPercentage =
          totalExpectedMarks > 0
            ? (totalActualPresent / totalExpectedMarks) * 100
            : 0;
        
        // Prepare Top Students list based on Attendance
        stats.topStudentsByAttendance = students
          .map((s) => ({
            name: s.name,
            percentage: stats.studentStats[s.id]?.overallAttendancePercent || 0,
          }))
          .sort((a, b) => b.percentage - a.percentage)
          .slice(0, 10);

        return stats;
      }
      
      // NEW: Calculate exam averages for all students
      function calculateStudentExamAverages() {
        const studentAverages = {}; // {studentId: {totalScore, totalMaxMarks, percentage, examCount}}

        students.forEach(s => {
            studentAverages[s.id] = {
                totalScore: 0,
                totalMaxMarks: 0,
                percentage: 0,
                examCount: 0
            };
        });

        allExamRecords.forEach(record => {
            const studentId = record.studentId;
            const score = record.score;
            const maxMarks = record.maxMarks;

            if (studentAverages[studentId]) {
                // Global Totals
                studentAverages[studentId].totalScore += score;
                studentAverages[studentId].totalMaxMarks += maxMarks;
                studentAverages[studentId].examCount++;
            }
        });

        // Calculate final percentages
        Object.keys(studentAverages).forEach(studentId => {
            const avg = studentAverages[studentId];
            if (avg.totalMaxMarks > 0) {
                avg.percentage = (avg.totalScore / avg.totalMaxMarks) * 100;
            }
        });
        
        // Prepare Top Students list based on Exam Marks
        const topStudentsByMarks = students
            .map(s => ({
                name: s.name,
                percentage: studentAverages[s.id]?.percentage || 0,
            }))
            .filter(s => studentAverages[students.find(st => st.name === s.name)?.id]?.examCount > 0) // Only include students who took at least one exam
            .sort((a, b) => b.percentage - a.percentage)
            .slice(0, 10);

        return { studentAverages, topStudentsByMarks };
      }

      // --- UI & STATE MANAGEMENT ---

      function getStatusClasses(status) {
        return `status-${status.charAt(0)}`;
      }
      
      // NEW: Helper function to get the icon/text for the status
      function getStatusContent(status) {
        switch (status) {
            case 'P':
                return '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
            case 'A':
                return '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>';
            case 'L':
                return 'L';
            case 'PH': // Public Holiday
                return 'H';
            case 'U':
                return ''; // Empty for unmarked
            default:
                return '-';
        }
      }


      function showMessage(text, color) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = `text-sm font-semibold h-5 mt-1 ${
          color === "green" ? "text-green-600" : "text-red-600"
        }`;
        setTimeout(() => (messageEl.textContent = ""), 4000);
      }
      
      // Helper function to show messages in the Edit Student Modal
      function showEditMessage(text, color) {
        const messageEl = document.getElementById("edit-student-message");
        messageEl.textContent = text;
        messageEl.className = `text-sm font-semibold h-5 mt-1 ${
          color === "green" ? "text-green-600" : "text-red-600"
        }`;
        setTimeout(() => (messageEl.textContent = ""), 4000);
      }

      function setActiveNav(viewName) {
        // 1. Desktop Nav
        document.querySelectorAll(".menu-item").forEach((item) => {
          item.classList.remove("active-nav");
          if (item.dataset.view === viewName) {
            item.classList.add("active-nav");
          }
        });

        // 2. Mobile Nav
        document.querySelectorAll(".mobile-nav-item").forEach((item) => {
            item.classList.remove("mobile-active-nav", "text-indigo-600");
            item.classList.add("text-gray-500");
            if (item.dataset.view === viewName) {
                item.classList.add("mobile-active-nav", "text-indigo-600");
                item.classList.remove("text-gray-500");
            }
        });
      }

      function renderView(viewName) {
        currentView = viewName;
        setActiveNav(viewName);

        // Update Title
        const menuItem = document.querySelector(`.menu-item[data-view="${viewName}"]`);
        if (menuItem) {
            // Use desktop item text for the title since it's more descriptive
            viewTitle.textContent = menuItem.textContent.trim();
        }

        viewContainer.innerHTML = "";
        
        // RENDER CHECK: If Firebase is not initialized, show error on data-dependent views
        if (!firebaseConfig && viewName !== 'dashboard') {
            viewContainer.innerHTML = `<div class="p-8 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-2">Database Connection Error (Config Missing)</h3>
                <p>This view requires a live database connection to load student records or save data. Please ensure the Firebase configuration is correctly supplied to the application environment.</p>
            </div>`;
            return;
        }


        switch (viewName) {
          case "dashboard":
            renderDashboard();
            break;
          case "students":
            renderStudentManagement();
            break;
          case "attendance":
            renderMonthlyAttendance(); // Renamed function
            break;
          case "reports":
            renderReports();
            break;
          case "exams":
            renderExamResults();
            break;
        }
      }

      // --- VIEW RENDERING FUNCTIONS ---

      function renderDashboard() {
        const stats = calculateAttendanceStats();
        const examStats = calculateStudentExamAverages(); // NEW: Calculate exam stats
        
        const totalStudents = stats.totalStudents;
        const totalPresentMarks = stats.totalPresent + stats.totalLate;
        const totalAbsentMarks = stats.totalAbsent;
        const overallAttendancePercent = stats.globalPercentage;
        
        // Lists for Top Students
        const topAttendanceListHtml = students.length === 0 ? 
            '<li class="text-gray-500 text-center">No students available.</li>' :
            stats.topStudentsByAttendance
            .map((s, index) => `
                <li class="hover:bg-indigo-50/50 transition duration-100 p-2 rounded-lg">
                    <span class="student-rank">${index + 1}.</span>
                    <span class="truncate">${s.name}</span>
                    <span class="student-value text-green-600">${s.percentage.toFixed(1)}%</span>
                </li>
            `)
            .join("") || '<li class="text-gray-500 text-center">No attendance data to rank.</li>';

        const topMarksListHtml = students.length === 0 ? 
            '<li class="text-gray-500 text-center">No students available.</li>' :
            examStats.topStudentsByMarks
            .map((s, index) => `
                <li class="hover:bg-indigo-50/50 transition duration-100 p-2 rounded-lg">
                    <span class="student-rank">${index + 1}.</span>
                    <span class="truncate">${s.name}</span>
                    <span class="student-value text-indigo-600">${s.percentage.toFixed(1)}%</span>
                </li>
            `)
            .join("") || '<li class="text-gray-500 text-center">No exam results available to rank.</li>';

        // --- Dashboard HTML structure ---
        const html = `
                <div class="space-y-8">
                    <p class="text-xl font-medium text-gray-600">Performance and Attendance Overview</p>
                    
                    <!-- 1. Metric Cards (4 Cards Grid) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
                        
                        <!-- Total Students -->
                        <div class="metric-card">
                            <div class="icon-container bg-blue-500">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m11.115-7.443-2.289-.968A3.003 3.003 0 0015 10a3 3 0 00-2.356-1.185l-2.29-.968C9.55 7.14 8.789 7 8 7V6c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v1c.789 0 1.55.14 2.228.455l2.289.968A3.003 3.003 0 0121 12a3.003 3.003 0 01-2.356 2.815l-2.289.968m-14.777-6.002C5.972 8.358 6 9.176 6 10c0 1.831-.502 3.513-1.398 4.87C4.156 15.659 3.197 16.5 2 16.5"></path></svg>
                            </div>
                            <div>
                                <div class="metric-value text-blue-800">${totalStudents}</div>
                                <div class="metric-label">Total Students</div>
                            </div>
                        </div>

                        <!-- Total Present Marks -->
                        <div class="metric-card">
                            <div class="icon-container bg-green-500">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.047 12.007 12.007 0 00-2.479 6.012c0 5.484 3.424 10.334 8.411 11.954l.589.179.589-.179c4.987-1.62 8.411-6.47 8.411-11.954a12.007 12.007 0 00-2.479-6.012z"></path></svg>
                            </div>
                            <div>
                                <div class="metric-value text-green-800">${totalPresentMarks}</div>
                                <div class="metric-label">Total Present/Late Marks</div>
                            </div>
                        </div>

                        <!-- Total Absent Marks -->
                        <div class="metric-card">
                            <div class="icon-container bg-red-500">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m0 0L2 2"></path></svg>
                            </div>
                            <div>
                                <div class="metric-value text-red-800">${totalAbsentMarks}</div>
                                <div class="metric-label">Total Absent Marks</div>
                            </div>
                        </div>
                        
                        <!-- Overall Attendance Rate -->
                        <div class="metric-card">
                            <div class="icon-container bg-yellow-500">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <div class="metric-value text-yellow-800">${overallAttendancePercent.toFixed(1)}%</div>
                                <div class="metric-label">Overall Attendance Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. Performance Charts/Lists (Two Columns) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                        
                        <!-- Top Students by Attendance -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-semibold mb-4 text-green-700 border-b pb-2">Top 10 Students by Attendance %</h3>
                            <p class="text-sm text-gray-500 mb-4">Percentage of days marked Present or Late out of all marked days.</p>
                            <ul class="top-student-list space-y-2">
                                ${topAttendanceListHtml}
                            </ul>
                        </div>
                        
                        <!-- Top Students by Exam Marks -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Top 10 Students by Overall Exam %</h3>
                            <p class="text-sm text-gray-500 mb-4">Cumulative average percentage across all recorded exams.</p>
                            <ul class="top-student-list space-y-2">
                                ${topMarksListHtml}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        viewContainer.innerHTML = html;
      }

      function renderStudentManagement() {
        viewContainer.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-6">
                    
                    <!-- Add Student Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Add New Student</h3>
                        <form id="add-student-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                                    <input type="text" id="student-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="student-rollno" class="block text-sm font-medium text-gray-700">Roll No. (ID)</label>
                                    <input type="number" id="student-rollno" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="student-grade" class="block text-sm font-medium text-gray-700">Grade Level</label>
                                    <input type="text" id="student-grade" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 9, 10A, 7B">
                                </div>
                            </div>
                            <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">
                                Add Student
                            </button>
                        </form>
                    </div>

                    <!-- Student List Table -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Current Students List</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Roll No.</th>
                                        <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Name</th>
                                        <th class="py-3 px-4 sm:px-6 font-bold text-gray-600">Grade</th>
                                        <th class="py-3 px-4 sm:px-6 font-bold text-gray-600 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="student-list-mgmt" class="divide-y divide-gray-200">
                                    <!-- Student rows here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <p id="message" class="text-sm font-semibold h-5"></p>
                </div>
            `;

        updateStudentListMgmt();

        document
          .getElementById("add-student-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const name = document.getElementById("student-name").value.trim();
            const rollNo = parseInt(
              document.getElementById("student-rollno").value
            );
            const grade = document.getElementById("student-grade").value.trim();
            if (name && rollNo && grade) {
              addStudent(name, rollNo, grade);
              e.target.reset(); // Clear form
              document.getElementById("student-name").focus(); // Focus back to name field
            }
          });

        document
          .getElementById("student-list-mgmt")
          .addEventListener("click", (e) => {
            if (e.target.closest(".delete-btn")) {
              const studentId = e.target.closest(".delete-btn").dataset.id;
              if (confirm("Are you sure you want to delete this student permanently?")) {
                  deleteStudent(studentId);
              }
            }
            // Handle Edit Button Click
            if (e.target.closest(".edit-btn")) {
                const studentId = e.target.closest(".edit-btn").dataset.id;
                const studentData = students.find(s => s.id === studentId);
                if (studentData) {
                    openEditStudentModal(studentData);
                }
            }
          });
      }

      function updateStudentListMgmt() {
        const listBody = document.getElementById("student-list-mgmt");
        if (!listBody) return;

        listBody.innerHTML = "";
        
        // Group students by Grade
        const studentsByGrade = students.reduce((acc, student) => {
            // Use the normalized grade for grouping
            const grade = student.grade ? student.grade.trim().toUpperCase() : 'UNASSIGNED';
            if (!acc[grade]) {
                acc[grade] = [];
            }
            acc[grade].push(student);
            return acc;
        }, {});

        // Sort grades (e.g., '7B', '9', '10A')
        const gradesToDisplay = Object.keys(studentsByGrade).sort();

        gradesToDisplay.forEach(grade => {
            // Add Grade Header
            const headerRow = document.createElement("tr");
            headerRow.classList.add("bg-indigo-100", "font-bold");
            headerRow.innerHTML = `<td colspan="4" class="py-2 px-4 text-indigo-800">${grade} (${studentsByGrade[grade].length} Students)</td>`;
            listBody.appendChild(headerRow);

            // Add student rows for this grade
            studentsByGrade[grade].forEach((student) => {
                const row = document.createElement("tr");
                row.classList.add("hover:bg-gray-50");
                row.innerHTML = `
                            <td class="py-3 px-4 sm:px-6 text-gray-900">${student.rollNo}</td>
                            <td class="py-3 px-4 sm:px-6 text-gray-700">${student.name}</td>
                            <td class="py-3 px-4 sm:px-6 text-gray-700">${student.grade || 'N/A'}</td>
                            <td class="py-3 px-4 sm:px-6 text-center space-x-2">
                                <button class="edit-btn px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 text-xs" data-id="${student.id}">Edit</button>
                                <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150 text-xs" data-id="${student.id}">Delete</button>
                            </td>
                        `;
                listBody.appendChild(row);
            });
        });
      }
      
      // Open Edit Student Modal Function
      window.openEditStudentModal = function(student) {
          document.getElementById("edit-student-id").value = student.id;
          document.getElementById("edit-student-name").value = student.name;
          document.getElementById("edit-student-rollno").value = student.rollNo;
          document.getElementById("edit-student-grade").value = student.grade;
          showEditMessage("", "green"); // Clear previous messages
          editStudentModal.classList.remove('hidden');
      }

      function renderMonthlyAttendance() {
        const currentYear = monthlyViewDate.getFullYear();
        const currentMonth = monthlyViewDate.getMonth() + 1; // 1-indexed
        
        // --- NEW: Filter Students based on selected grade ---
        const studentsForAttendance = getStudentsByGrade(attendanceFilterGrade);
        
        // --- Calculate Month/Days ---
        const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
        const lastDayOfMonth = new Date(currentYear, currentMonth, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        
        // Generate array of date objects for the current month
        const daysOfMonth = [];
        for(let i = 1; i <= daysInMonth; i++) {
            daysOfMonth.push(new Date(currentYear, currentMonth - 1, i));
        }

        const monthOptions = [
          { val: 1, name: "January" },
          { val: 2, name: "February" },
          { val: 3, name: "March" },
          { val: 4, name: "April" },
          { val: 5, name: "May" },
          { val: 6, name: "June" },
          { val: 7, name: "July" },
          { val: 8, name: "August" },
          { val: 9, name: "September" },
          { val: 10, name: "October" },
          { val: 11, name: "November" },
          { val: 12, name: "December" },
        ]
          .map(
            (m) =>
              `<option value="${m.val}" ${
                m.val === currentMonth ? "selected" : ""
              }>${m.name}</option>`
          )
          .join("");

        const yearOptions = [currentYear - 1, currentYear, currentYear, currentYear + 1]
          .map(
            (y) =>
              `<option value="${y}" ${
                y === currentYear ? "selected" : ""
              }>${y}</option>`
          )
          .filter((value, index, self) => self.indexOf(value) === index) // Unique years
          .join("");
          
        const gradeOptions = allGrades.map(g => 
             `<option value="${g}" ${g === attendanceFilterGrade ? 'selected' : ''}>Grade ${g}</option>`
        ).join('');


        viewContainer.innerHTML = `
                <div class="space-y-6">
                    <p id="message" class="text-sm font-semibold h-5"></p>
                    
                    <!-- Month/Year Selector and Grade Filter -->
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-3">
                            <h3 class="text-xl font-semibold text-indigo-700">Attendance Calendar</h3>
                            <div class="flex flex-wrap gap-2 items-center">
                                <select id="monthly-select-grade" class="p-2 border border-gray-300 rounded-lg shadow-sm w-32">
                                    ${gradeOptions}
                                </select>
                                <select id="monthly-select-month" class="p-2 border border-gray-300 rounded-lg shadow-sm w-32">
                                    ${monthOptions}
                                </select>
                                <select id="monthly-select-year" class="p-2 border border-gray-300 rounded-lg shadow-sm w-24">
                                    ${yearOptions}
                                </select>
                            </div>
                        </div>

                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200 mt-4">
                            <h4 class="text-md font-semibold text-indigo-700 mb-2">Monthly Quick Mark (Current View: Grade ${attendanceFilterGrade})</h4>
                            <div class="flex flex-wrap gap-3 items-center">
                                <button id="monthly-mark-btn" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 text-sm">
                                    Mark All Present (Grade ${attendanceFilterGrade})
                                </button>
                                <p class="text-xs text-indigo-500">Marks Sun-Fri as 'Present' for the selected grade. Overwrites existing data.</p>
                            </div>
                        </div>
                    </div>
                    <!-- END: Month/Year Selector and Quick Mark -->

                    <!-- Monthly Attendance Calendar Table -->
                    <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-200 bg-white">
                        <table class="min-w-full text-sm text-left border-collapse table-fixed">
                            <thead class="bg-indigo-600 text-white sticky top-0 z-10" id="monthly-attendance-header">
                                <tr>
                                    <!-- Sticky Columns -->
                                    <th scope="col" class="py-3 px-0 w-8 min-w-[32px] font-bold sticky-col-roll text-center">Roll</th>
                                    <th scope="col" class="py-3 px-1 w-24 min-w-[96px] max-w-[96px] font-bold sticky-col-name">Name</th>
                                    
                                    <!-- Monthly Day Headers -->
                                    ${daysOfMonth.map(date => {
                                        const dayIndex = date.getDay(); // 0=Sun, 6=Sat
                                        const dayNames = ["S", "M", "T", "W", "T", "F", "S"]; // Sun to Sat
                                        const dayName = dayNames[dayIndex];
                                        const isHoliday = date.getDay() === 6; // Saturday is Holiday
                                        
                                        return `<th scope="col" class="calendar-header-cell ${isHoliday ? "holiday" : ""}">
                                                        <div class="text-[0.6rem] font-normal">${dayName}</div>
                                                        <div class="text-xs font-bold">${date.getDate()}</div>
                                                    </th>`;
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody id="monthly-calendar-body" class="divide-y divide-gray-200">
                                <!-- Student rows injected here -->
                            </tbody>
                        </table>
                        <div id="no-students-message" class="text-center py-10 text-gray-500 hidden">
                             No students found for Grade ${attendanceFilterGrade}.
                        </div>
                    </div>
                </div>
            `;
        
        // --- NEW: Grade Filter Listener ---
        document
          .getElementById("monthly-select-grade")
          .addEventListener("change", (e) => {
              attendanceFilterGrade = e.target.value;
              renderMonthlyAttendance();
          });
          
        // Attach event listeners for month/year change
        document
          .getElementById("monthly-select-month")
          .addEventListener("change", window.updateMonthlyViewDate);
        document
          .getElementById("monthly-select-year")
          .addEventListener("change", window.updateMonthlyViewDate);
        document
          .getElementById("monthly-mark-btn")
          .addEventListener("click", window.handleMonthlyMark);
          
        // Attach click listener to the table body for cell updates (delegation)
        document
          .getElementById("monthly-calendar-body")
          .addEventListener("click", window.handleAttendanceCellClick);

        // Initial render of the calendar body
        renderMonthlyCalendarBody(daysOfMonth, studentsForAttendance);
      }
      
      // Helper to handle month/year dropdown changes
      window.updateMonthlyViewDate = function() { // Made global
        const month = parseInt(
          document.getElementById("monthly-select-month").value
        );
        const year = parseInt(
          document.getElementById("monthly-select-year").value
        );
        monthlyViewDate = new Date(year, month - 1); // Month is 0-indexed in JS Date object
        renderMonthlyAttendance(); // Re-render the entire view
      }

      // Helper to handle monthly mark button click
      window.handleMonthlyMark = function() { // Made global
        const month = parseInt(
          document.getElementById("monthly-select-month").value
        );
        const year = parseInt(
          document.getElementById("monthly-select-year").value
        );

        if (students.length === 0) {
          showMessage("Cannot mark: No students available.", "red");
          return;
        }

        const monthName = new Date(year, month - 1).toLocaleString("default", {
          month: "long",
        });
        console.log(
          `Confirmation required: Are you sure you want to mark ALL ${students.length} students as 'Present' for all school days (Sun-Fri) in ${monthName} ${year}? This will overwrite existing records.`
        );

        markMonthPresent(year, month);
      }

      // Helper to handle attendance cell clicks (toggle status)
      window.handleAttendanceCellClick = function(event) { // MADE GLOBAL
        const cell = event.target.closest(".attendance-mark");
        // The cell check needs to ensure it's not a holiday/unclickable cell
        if (!cell || cell.classList.contains("holiday") || cell.dataset.status === '-') return; 

        const studentId = cell.dataset.studentId;
        const date = cell.dataset.date;
        const currentStatus = cell.dataset.status;

        let newStatus;
        switch (currentStatus) {
          case "P":
            newStatus = "Absent";
            break;
          case "A":
            newStatus = "Late";
            break;
          case "L":
            newStatus = "PH"; // **FIXED: Cycle from Late to Public Holiday**
            break; 
          case "PH":
            newStatus = "Unmarked"; // **FIXED: Cycle from Public Holiday to Unmarked**
            break; 
          case "U":
            newStatus = "Present";
            break; 
          default:
            newStatus = "Present"; // Fallback
        }

        // Update Firestore
        setAttendanceRecord(studentId, date, newStatus);
        // UI update happens automatically via the global onSnapshot listener for allAttendanceRecords
      }

      // Primary function to populate the monthly calendar table
      function renderMonthlyCalendarBody(daysOfMonth, studentsForAttendance) {
        const listBody = document.getElementById("monthly-calendar-body");
        const noStudentsMessage = document.getElementById(
          "no-students-message"
        );
        if (!listBody) return;

        listBody.innerHTML = "";

        if (studentsForAttendance.length === 0) {
          noStudentsMessage.classList.remove("hidden");
          return;
        }
        noStudentsMessage.classList.add("hidden");

        const datePrefix = formatDateLocal(monthlyViewDate).slice(0, 7); // **FIXED: Use local formatter**

        // 1. Create a quick lookup map for attendance records in the current month
        const attendanceMap = allAttendanceRecords.reduce((acc, record) => {
          if (record.date.startsWith(datePrefix)) {
            if (!acc[record.studentId]) {
              acc[record.studentId] = {};
            }
            // Uses slice(8, 10) on the stored date string (YYYY-MM-DD) to get the day
            acc[record.studentId][record.date.slice(8, 10)] =
              record.status.charAt(0); // 'P', 'A', 'L', 'PH'
          }
          return acc;
        }, {});

        // 2. Build the table rows using the FILTERED student list
        studentsForAttendance.forEach((student) => {
          const row = document.createElement("tr");
          row.classList.add("hover:bg-gray-50", "transition", "duration-150");

          let cellsHtml = `
                    <td class="py-3 px-0 w-8 min-w-[32px] font-medium text-gray-900 sticky-col-roll text-center">${student.rollNo}</td>
                    <td class="py-3 px-1 w-24 min-w-[96px] text-gray-700 sticky-col-name">${student.name}</td>
                `;
          
          daysOfMonth.forEach(date => {
            const dateStr = formatDateLocal(date); // **FIXED: Use local formatter for data-date**
            const dayKey = String(date.getDate()).padStart(2, "0");
            const isSaturday = date.getDay() === 6; // Saturday (Day 6) is Holiday
            
            // Check if there is an existing record for the current date
            const existingStatus = attendanceMap[student.id]?.[dayKey];
            
            let statusCharHtml, status, statusClass;

            if (isSaturday) {
                // Saturday is a forced non-clickable holiday
                status = 'PH'; 
                statusCharHtml = getStatusContent(status);
                statusClass = getStatusClasses(status);
            } else {
                // Regular school day
                status = existingStatus || "U";
                statusCharHtml = getStatusContent(status);
                statusClass = getStatusClasses(status);
            }
            
            // If it's a Saturday, apply the holiday class and prevent interaction
            const cellClasses = `calendar-cell attendance-mark border border-gray-100 flex items-center justify-center ${statusClass} ${isSaturday ? "holiday pointer-events-none" : ""}`;

            cellsHtml += `
                        <td class="p-0">
                            <div class="${cellClasses}" 
                                data-student-id="${student.id}" 
                                data-date="${dateStr}" 
                                data-status="${status}"
                                title="${dateStr} - ${student.name} - ${status === 'U' ? 'Unmarked' : status}">
                                ${statusCharHtml}
                            </div>
                        </td>
                    `;
          });


          row.innerHTML = cellsHtml;
          listBody.appendChild(row);
        });
      }


      // --- Helper function to render the Attendance Report Content ---
      function renderAttendanceReportContent(stats) {
          const studentRows = students
          .map((s) => {
            const sStats = stats.studentStats[s.id];
            
            // Get the calculated monthly and cumulative stats
            const presentThisMonth = sStats?.presentThisMonth || 0;
            const presentTillLastMonth = sStats?.presentTillLastMonth || 0;
            const totalPresent = presentThisMonth + presentTillLastMonth; // Sum of the two required columns
            const percentage = sStats?.overallAttendancePercent || 0; // Use the newly calculated overall percentage

            return `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-4 sm:px-6 font-medium text-gray-900">${
                          s.rollNo
                        }</td>
                        <td class="py-3 px-4 sm:px-6 text-gray-700">${
                          s.name
                        }</td>
                        <td class="py-3 px-4 text-center text-indigo-600 font-semibold">${presentThisMonth}</td>
                        <td class="py-3 px-4 text-center text-indigo-600 font-semibold">${presentTillLastMonth}</td>
                        <td class="py-3 px-4 text-center font-extrabold text-green-700">${totalPresent}</td>
                        <td class="py-3 px-4 font-bold text-center ${
                          percentage > 90
                            ? "text-green-600"
                            : percentage > 70
                            ? "text-yellow-600"
                            : "text-red-600"
                        }">${percentage.toFixed(1)}%</td>
                    </tr>
                `;
          })
          .join("");
          
          return `
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Overall Attendance Rate</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${stats.globalPercentage.toFixed(
                          1
                        )}%</p>
                        <p class="text-xs text-gray-400">(All time attendance)</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Total Present (P + L)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${
                          stats.totalPresent + stats.totalLate
                        }</p>
                        <p class="text-xs text-gray-400">Total present and late marks.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Total Absent (A)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${
                          stats.totalAbsent
                        }</p>
                        <p class="text-xs text-gray-400">Total absent marks.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700">Individual Student Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 font-bold text-gray-600">Roll No.</th>
                                    <th class="py-3 px-4 font-bold text-gray-600">Name</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">This Month (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Present Till Last Month (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Total Present (P+L)</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 text-center">Overall %</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${
                                  studentRows ||
                                  '<tr><td colspan="6" class="py-4 text-center text-gray-500">No student data to display.</td></tr>'
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
          `;
      }
      
      // --- Function to render the Exam Report Content ---
      function renderExamReportContent() {
          // New state to filter reports
          let reportGradeFilter = viewContainer.dataset.reportGradeFilter || 'All'; 
          
          // Filter exam records based on selected grade
          const filteredExamRecords = allExamRecords.filter(r => 
              reportGradeFilter === 'All' || (r.studentGrade && String(r.studentGrade).trim().toUpperCase() === reportGradeFilter.trim().toUpperCase())
          );
          
          // 1. Group records by exam batch (Subject, Type, Date)
          const examBatches = filteredExamRecords.reduce((acc, record) => {
              const key = record.examBatchId;
              if (!acc[key]) {
                  acc[key] = {
                      examBatchId: key, // Store ID for linking
                      subject: record.subject,
                      type: record.type,
                      date: record.date,
                      maxMarks: record.maxMarks,
                      totalScore: 0,
                      count: 0,
                      grade: record.studentGrade, // Added grade for display
                  };
              }
              acc[key].totalScore += record.score;
              acc[key].count++;
              return acc;
          }, {});

          const batchRows = Object.values(examBatches)
              .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
              .map(batch => {
                  const classAverage = batch.totalScore / batch.count;
                  const percentage = (classAverage / batch.maxMarks) * 100;
                  
                  // Ensure string parameters passed to onclick are correctly quoted and escaped
                  const onClickHandler = `deleteExamBatch('${batch.examBatchId}', '${batch.subject.replace(/'/g, "\\'")}', '${batch.type.replace(/'/g, "\\'")}')`;

                  return `
                      <tr class="bg-white hover:bg-gray-50 border-y border-gray-200">
                          <td class="py-3 px-4 font-medium text-gray-900">${batch.subject}</td>
                          <td 
                              class="py-3 px-4 text-gray-700 exam-batch-link cursor-pointer hover:text-indigo-600 font-semibold" 
                              data-batch-id="${batch.examBatchId}"
                              onclick="openExamDetailsModal('${batch.examBatchId}')"
                          >
                              ${batch.type} (${batch.date})
                          </td>
                          <td class="py-3 px-4 text-center font-semibold">${batch.maxMarks}</td>
                          <td class="py-3 px-4 text-center">${batch.grade}</td>
                          <td class="py-3 px-4 text-center">${batch.count}</td>
                          <td class="py-3 px-4 text-center font-semibold text-indigo-600">${classAverage.toFixed(1)}</td>
                          <td class="py-3 px-4 text-center font-extrabold ${percentage >= 70 ? 'text-green-600' : 'text-red-600'}">${percentage.toFixed(1)}%</td>
                          <td class="py-3 px-4 text-center">
                              <button onclick="${onClickHandler}" 
                                      class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100" title="Delete Exam Batch">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                              </button>
                          </td>
                      </tr>
                  `;
              }).join('');
              
          // Grade options for the report filter
          const gradeFilterOptions = ['All', ...allGrades].map(g => 
              `<option value="${g}" ${g === reportGradeFilter ? 'selected' : ''}>${g === 'All' ? 'All Grades' : 'Grade ' + g}</option>`
          ).join('');

          return `
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-indigo-700">Exam Batch Summaries (Click Test Details)</h3>
                
                <div class="flex justify-end mb-4">
                    <label for="report-grade-filter" class="text-sm font-medium text-gray-700 mr-2">Filter Grade:</label>
                    <select id="report-grade-filter" class="p-2 border border-gray-300 rounded-lg shadow-sm">
                        ${gradeFilterOptions}
                    </select>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 font-bold text-gray-600">Subject</th>
                                <th class="py-3 px-4 font-bold text-gray-600">Test Details (Date)</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Max Marks</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Grade</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Students Marked</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Class Average Score</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Average %</th>
                                <th class="py-3 px-4 font-bold text-gray-600 text-center">Delete</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${batchRows || '<tr><td colspan="8" class="py-4 text-center text-gray-500">No exam results found for this grade.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
          `;
          
          // Event Listener for the Grade Filter
          document.getElementById('report-grade-filter').addEventListener('change', (e) => {
              viewContainer.dataset.reportGradeFilter = e.target.value;
              renderView('reports');
          });
      }

      function renderReports() {
        const stats = calculateAttendanceStats();
        // Use a dataset attribute on the view container to maintain tab state across renders
        let currentReportTab = viewContainer.dataset.reportTab || 'attendance';

        const tabHtml = `
            <div class="space-y-6">
                <p class="text-xl font-medium text-gray-600">Detailed performance analysis.</p>
                <div class="mb-6">
                    <div class="flex space-x-4"> <!-- Changed to flex space-x-4 for pill style -->
                        <button 
                            data-tab="attendance" 
                            class="report-tab-btn px-4 py-2 font-semibold rounded-lg transition duration-150 ${currentReportTab === 'attendance' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                        >
                            Attendance Records
                        </button>
                        <button 
                            data-tab="results" 
                            class="report-tab-btn px-4 py-2 font-semibold rounded-lg transition duration-150 ${currentReportTab === 'results' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}"
                        >
                            Exam Results
                        </button>
                    </div>
                    <div class="mt-4 h-1"></div> <!-- Spacer -->
                </div>
                <div id="report-tab-content">
                    <!-- Tab content loaded here -->
                </div>
            </div>
        `;

        viewContainer.innerHTML = tabHtml;
        
        // Render the correct content based on the active tab
        const contentEl = document.getElementById('report-tab-content');
        if (currentReportTab === 'attendance') {
            contentEl.innerHTML = renderAttendanceReportContent(stats);
        } else {
            contentEl.innerHTML = renderExamReportContent();
        }


        // Attach click listeners for tabs
        document.querySelectorAll('.report-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const newTab = e.target.dataset.tab;
                viewContainer.dataset.reportTab = newTab; // Save new state
                renderView('reports'); // Re-render the view to apply changes
            });
        });
      }
      
      // Function to handle grade selection in the exam input view
      window.handleExamGradeSelection = function(grade) {
          selectedExamGrade = grade;
          // FIX: Force full re-render after grade selection to fetch the filtered student list
          renderView('exams'); 
      }

      function renderExamResults() {
        if (students.length === 0) {
            viewContainer.innerHTML = `
                <div class="p-8 bg-white rounded-xl shadow-lg text-center">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Exam Results</h3>
                    <p class="text-gray-600">Please add students in the **Student Management** section before entering exam scores.</p>
                </div>
            `;
            return;
        }

        const today = new Date().toISOString().slice(0, 10);
        
        // --- GRADE SELECTION OPTIONS ---
        // CHANGED: The first option is now explicitly 'Select Grade' and disabled
        const gradeOptions = [
            `<option value="" ${selectedExamGrade === '' ? 'selected' : ''} disabled>Select Grade</option>`,
             ...allGrades.map(g => 
                `<option value="${g}" ${g === selectedExamGrade ? 'selected' : ''}>Grade ${g}</option>`
             )
        ].join('');

        
        // --- Step 1: Grade Selection UI ---
        // The check now ensures that if selectedExamGrade is an empty string (the value of 'Select Grade'), it shows the prompt.
        if (!selectedExamGrade) {
             viewContainer.innerHTML = `
                <div class="max-w-md mx-auto p-8 bg-white rounded-xl shadow-lg text-center space-y-4">
                    <h3 class="text-xl font-semibold text-indigo-700">Select Grade for Scoring</h3>
                    <p class="text-gray-600">Choose the grade level you are currently entering exam scores for.</p>
                    <select id="exam-grade-selector" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm text-lg">
                        ${gradeOptions}
                    </select>
                </div>
             `;
             document.getElementById('exam-grade-selector').addEventListener('change', (e) => {
                 handleExamGradeSelection(e.target.value);
             });
             return;
        }
        
        // --- Step 2: Load Students and Scoring UI (Only runs if a grade is selected) ---
        // This relies on the FIXED getStudentsByGrade function
        const studentsForScoring = getStudentsByGrade(selectedExamGrade);
        
        // If the selected grade is valid but yields no students, show a message
        if (studentsForScoring.length === 0) {
             viewContainer.innerHTML = `
                <div class="max-w-md mx-auto p-8 bg-white rounded-xl shadow-lg text-center space-y-4">
                    <h4 class="text-lg font-bold text-indigo-800">Entering Scores for: Grade ${selectedExamGrade}</h4>
                    <p class="text-gray-600">No students found for **Grade ${selectedExamGrade}**.</p>
                    <p class="text-sm text-gray-500">Please check your student list in the **Student Management** section, or click 'Change Grade' below.</p>
                    <button onclick="handleExamGradeSelection('')" class="mt-4 px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">
                        Change Grade
                    </button>
                </div>
             `;
             return;
        }


        const studentScoreRows = studentsForScoring.map(s => `
            <tr class="hover:bg-gray-50">
                <td class="py-3 px-4 text-gray-900">${s.rollNo}</td>
                <td class="py-3 px-4 text-gray-700">${s.name}</td>
                <td class="py-3 px-4 text-gray-700">${s.grade || 'N/A'}</td>
                <td class="py-3 px-4">
                    <input type="number" step="0.1" data-id="${s.id}" class="score-input w-24 p-1 border border-gray-300 rounded-md text-center focus:ring-indigo-500 focus:border-indigo-500" placeholder="Score">
                </td>
            </tr>
        `).join('');

        viewContainer.innerHTML = `
            <div class="space-y-6">
                <p id="message" class="text-sm font-semibold h-5"></p>
                
                <!-- Currently Selected Grade Display -->
                <div class="bg-indigo-50 p-3 rounded-xl shadow-inner border border-indigo-200 flex justify-between items-center">
                    <h4 class="text-lg font-bold text-indigo-800">Entering Scores for: Grade ${selectedExamGrade}</h4>
                    <button onclick="handleExamGradeSelection('')" class="text-sm text-indigo-600 hover:text-indigo-900 font-semibold underline">
                        Change Grade
                    </button>
                </div>

                <!-- Exam Details Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Exam Details</h3>
                    <form id="exam-details-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="exam-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                                <input type="text" id="exam-subject" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-type" class="block text-sm font-medium text-gray-700">Test Type</label>
                                <input type="text" id="exam-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-max-marks" class="block text-sm font-medium text-gray-700">Max Marks</label>
                                <input type="number" id="exam-max-marks" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="exam-date" class="block text-sm font-medium text-gray-700">Exam Date</label>
                                <input type="date" id="exam-date" value="${today}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Score Entry Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Student Scores (${studentsForScoring.length} Students)</h3>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full text-sm text-left divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Roll No.</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-2/5">Student Name</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Grade</th>
                                    <th class="py-3 px-4 font-bold text-gray-600 w-1/5">Marks Scored</th>
                                </tr>
                            </thead>
                            <tbody id="student-score-list" class="divide-y divide-gray-200">
                                ${studentScoreRows}
                            </tbody>
                        </table>
                    </div>
                    <button id="save-scores-btn" class="mt-6 w-full px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                        Save Exam Results
                    </button>
                </div>
            </div>
        `;

        // Add event listener for saving scores
        document.getElementById('save-scores-btn').addEventListener('click', () => {
            const subject = document.getElementById('exam-subject').value.trim();
            const type = document.getElementById('exam-type').value.trim(); 
            const maxMarks = document.getElementById('exam-max-marks').value;
            const date = document.getElementById('exam-date').value;

            if (!subject || !type || !maxMarks || !date) {
                showMessage("Please fill in all Exam Details (Subject, Type, Max Marks, Date).", "red");
                return;
            }

            const scoreInputs = document.querySelectorAll('.score-input');
            const scores = {};
            
            let allScoresValid = true;
            scoreInputs.forEach(input => {
                const studentId = input.dataset.id;
                const scoreValue = input.value.trim();
                
                if (scoreValue !== "") {
                    const scoreNum = parseFloat(scoreValue);
                    const maxNum = parseInt(maxMarks);
                    
                    if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > maxNum) {
                        allScoresValid = false;
                        input.classList.add('border-red-500', 'ring-red-500');
                        input.focus();
                    } else {
                         input.classList.remove('border-red-500', 'ring-red-500');
                         scores[studentId] = scoreNum;
                    }
                }
            });

            if (!allScoresValid) {
                 showMessage(`One or more scores are invalid. They must be between 0 and ${maxMarks}.`, "red");
                 return;
            }

            if (Object.keys(scores).length === 0) {
                 showMessage("Please enter at least one score.", "red");
                 return;
            }

            saveExamResults(subject, type, maxMarks, date, scores);
        });
      }
      
      // Function to close any modal
      window.closeModal = function(modalId) {
          document.getElementById(modalId).classList.add('hidden');
      }

      // Function to open the exam details modal and populate with batch data
      window.openExamDetailsModal = function(batchId) {
          const batchRecords = allExamRecords.filter(r => r.examBatchId === batchId);
          
          if (batchRecords.length === 0) {
              showMessage("No detailed records found for this exam batch.", "red");
              return;
          }

          // All records in the batch share the same exam details
          const examDetails = batchRecords[0];
          const maxMarks = examDetails.maxMarks;

          // Populate Modal Header
          document.getElementById('modal-title').innerHTML = 
              `${examDetails.subject} - ${examDetails.type} <span class="text-sm font-normal text-gray-500">(Max Marks: ${maxMarks})</span>`;

          // Generate student results table content
          const studentResults = batchRecords
              .map(record => {
                  const percentage = (record.score / maxMarks) * 100;
                  const rollNo = students.find(s => s.id === record.studentId)?.rollNo || 'N/A';
                  
                  return `
                      <tr class="hover:bg-gray-50">
                          <td class="py-2 px-4 font-medium">${rollNo}</td>
                          <td class="py-2 px-4">${record.studentName}</td>
                          <td class="py-2 px-4">${record.studentGrade || 'N/A'}</td>
                          <td class="py-2 px-4 text-center text-lg font-bold">${record.score}</td>
                          <td class="py-2 px-4 text-center font-semibold ${percentage >= 70 ? 'text-green-600' : 'text-red-600'}">${percentage.toFixed(1)}%</td>
                      </tr>
                  `;
              }).join('');
              
          const modalContentHtml = `
              <p class="text-sm text-gray-600 mb-4">Exam Date: ${examDetails.date}</p>
              <div class="overflow-x-auto max-h-[60vh] border rounded-lg">
                  <table class="min-w-full text-sm divide-y divide-gray-200">
                      <thead class="bg-gray-50 sticky top-0">
                          <tr>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-1/6">Roll No.</th>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-3/6">Student Name</th>
                              <th class="py-3 px-4 text-left text-xs font-bold text-gray-600 uppercase w-1/6">Grade</th>
                              <th class="py-3 px-4 text-center text-xs font-bold text-gray-600 uppercase w-1/6">Score</th>
                              <th class="py-3 px-4 text-center text-xs font-bold text-gray-600 uppercase w-1/6">Percentage</th>
                          </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                          ${studentResults}
                      </tbody>
                  </table>
              </div>
          `;
          
          document.getElementById('modal-content').innerHTML = modalContentHtml;
          examDetailsModal.classList.remove('hidden');
      }


      // --- INITIALIZATION & LISTENERS ---

      // 3. Navigation Listener (Handles both Mobile and Desktop Clicks)
      document.querySelectorAll(".menu-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const view = e.currentTarget.dataset.view;
          renderView(view);
        });
      });
      
      // Close modal on escape key press
      document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
              if (!examDetailsModal.classList.contains('hidden')) {
                  closeModal('exam-details-modal');
              }
              if (!editStudentModal.classList.contains('hidden')) {
                  closeModal('edit-student-modal');
              }
          }
      });
      
      // Close modal when clicking outside the modal content area
      [examDetailsModal, editStudentModal].forEach(modal => {
          modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                  closeModal(modal.id);
              }
          });
      });


      // 6. Initial Load: Call the initialization function when the window loads
      window.onload = function () {
        initializeFirebase();
      };
    </script>
  </body >
</html>
